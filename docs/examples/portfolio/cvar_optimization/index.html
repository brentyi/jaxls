
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>CVaR allocation &#8212; jaxls</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=2a1f1aab" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=55b5f74b"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=fd10adb8"></script>
    <script src="../../../_static/js/custom.js?v=58150dd0"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/portfolio/cvar_optimization';</script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="Black-Litterman allocation" href="../black_litterman/" />
    <link rel="prev" title="Reparameterized allocation" href="../reparameterized_allocation/" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../">
  
  
  
  
  
  
    <p class="title logo__title">jaxls</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../guide/basics/">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/tips_and_gotchas/">Tips and gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../guide/advanced/">Advanced</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../guide/advanced/non_euclidean/">Non-Euclidean variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide/advanced/custom_jacobians/">Custom Jacobians</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide/advanced/constraints/">Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide/advanced/robust_costs/">Robust costs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../guide/advanced/covariance/">Covariance estimation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mechanics/">Mechanics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mechanics/spring_equilibrium/">Spring equilibrium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mechanics/cloth_draping/">Cloth draping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mechanics/truss_analysis/">Truss analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../vision/">Vision</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../vision/camera_calibration/">Camera calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision/pose_graph_2d/">SE(2) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision/pose_graph_3d/">SE(3) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision/bundle_adjustment/">Bundle adjustment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision/smplh_shape_fitting/">SMPL-H shape fitting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../robotics/">Robotics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/inverse_kinematics/">Inverse kinematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/obstacle_avoidance/">Obstacle avoidance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/cart_pole_collocation/">Cart-pole (collocation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/cart_pole_shooting/">Cart-pole (shooting)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/cam_design/">Cam profile optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../robotics/imu_sensor_fusion/">IMU fusion + calibration</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../">Portfolio optimization</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../mean_variance/">Mean-variance allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../manifold_allocation/">Manifold allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reparameterized_allocation/">Reparameterized allocation</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">CVaR allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../black_litterman/">Black-Litterman allocation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../api/core/">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/lie_group_variables/">Lie group variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/solver_config/">Solver configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/covariance/">Covariance Estimation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Design Notes</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../design/typed_api/">Typed API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/sparse_matrices/">Sparse matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/traced_vs_static/">What’s traced?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/brentyi/jaxls" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/brentyi/jaxls/issues/new?title=Issue%20on%20page%20%2Fexamples/portfolio/cvar_optimization.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/examples/portfolio/cvar_optimization.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>CVaR allocation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#historical-stock-data">Historical stock data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cvar-vs-variance">CVaR vs variance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cvar-formulation">CVaR formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solving">Solving</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-cvar-vs-mean-variance">Comparison: CVaR vs mean-variance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-observations">Key observations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="cvar-allocation">
<h1>CVaR allocation<a class="headerlink" href="#cvar-allocation" title="Link to this heading">#</a></h1>
<p>In this notebook, we solve a CVaR portfolio optimization problem: minimizing
expected losses in the worst-case scenarios rather than overall variance.</p>
<p>Unlike mean-variance optimization which penalizes all volatility equally, CVaR focuses on
worst-case scenarios: the expected loss in the worst α% of outcomes. This makes
it useful for risk-averse investors concerned about extreme market downturns.</p>
<p>This example is based on the formulation from <a class="reference external" href="https://pyportfolioopt.readthedocs.io/en/latest/GeneralEfficientFrontier.html">PyPortfolioOpt</a>
and <a class="reference external" href="https://sites.math.washington.edu/~rtr/papers/rtr179-CVaR1.pdf">Rockafellar &amp; Uryasev (2000)</a>.</p>
<p>Features used:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api/core/#jaxls.Var" title="jaxls.Var"><code class="xref py py-class docutils literal notranslate"><span class="pre">Var</span></code></a> with vector-valued and scalar defaults</p></li>
<li><p>Inequality constraints (<code class="docutils literal notranslate"><span class="pre">constraint_geq_zero</span></code>): CVaR auxiliary constraints, budget, no short-selling</p></li>
<li><p>Equality constraints (<code class="docutils literal notranslate"><span class="pre">constraint_eq_zero</span></code>): budget constraint</p></li>
<li><p>Augmented Lagrangian solver for constrained optimization</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="n">logger</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;level&gt;</span><span class="si">{level: &lt;8}</span><span class="s2">&lt;/level&gt; | </span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jaxls</span>
</pre></div>
</div>
</div>
</div>
<section id="historical-stock-data">
<h2>Historical stock data<a class="headerlink" href="#historical-stock-data" title="Link to this heading">#</a></h2>
<p>We use the same dataset as the <a class="reference internal" href="../mean_variance/"><span class="doc">Mean-variance allocation</span></a> example:
monthly stock prices from November 2000 to November 2001 for IBM, Walmart (WMT),
and Southern Electric (SEHI).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;IBM&quot;</span><span class="p">,</span> <span class="s2">&quot;WMT&quot;</span><span class="p">,</span> <span class="s2">&quot;SEHI&quot;</span><span class="p">]</span>

<span class="c1"># Monthly prices (13 months: Nov 2000 - Nov 2001)</span>
<span class="n">prices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mf">93.043</span><span class="p">,</span> <span class="mf">51.826</span><span class="p">,</span> <span class="mf">1.063</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">84.585</span><span class="p">,</span> <span class="mf">52.823</span><span class="p">,</span> <span class="mf">0.938</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">111.453</span><span class="p">,</span> <span class="mf">56.477</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">99.525</span><span class="p">,</span> <span class="mf">49.805</span><span class="p">,</span> <span class="mf">0.938</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">95.819</span><span class="p">,</span> <span class="mf">50.287</span><span class="p">,</span> <span class="mf">1.438</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">114.708</span><span class="p">,</span> <span class="mf">51.521</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">111.515</span><span class="p">,</span> <span class="mf">51.531</span><span class="p">,</span> <span class="mf">2.54</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">113.211</span><span class="p">,</span> <span class="mf">48.664</span><span class="p">,</span> <span class="mf">2.39</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">104.942</span><span class="p">,</span> <span class="mf">55.744</span><span class="p">,</span> <span class="mf">3.12</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">99.827</span><span class="p">,</span> <span class="mf">47.916</span><span class="p">,</span> <span class="mf">2.98</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">91.607</span><span class="p">,</span> <span class="mf">49.438</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">107.937</span><span class="p">,</span> <span class="mf">51.336</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">115.59</span><span class="p">,</span> <span class="mf">55.081</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">],</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Monthly returns: (P[t+1] - P[t]) / P[t]</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">prices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">num_scenarios</span><span class="p">,</span> <span class="n">num_assets</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">shape</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Returns shape: </span><span class="si">{</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">num_scenarios</span><span class="si">}</span><span class="s2"> scenarios x </span><span class="si">{</span><span class="n">num_assets</span><span class="si">}</span><span class="s2"> assets)&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Monthly returns (%):</span><span class="se">\n</span><span class="si">{</span><span class="n">returns</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Returns shape: (12, 3) (12 scenarios x 3 assets)

Monthly returns (%):
[[-9.09042072e+00  1.92374790e+00 -1.17591667e+01]
 [ 3.17645016e+01  6.91743946e+00  6.60980558e+00]
 [-1.07022705e+01 -1.18136597e+01 -6.19999790e+00]
 [-3.72368884e+00  9.67771173e-01  5.33048973e+01]
 [ 1.97132092e+01  2.45391679e+00  1.82197552e+01]
 [-2.78359032e+00  1.94063038e-02  4.94117584e+01]
 [ 1.52087092e+00 -5.56363535e+00 -5.90550661e+00]
 [-7.30405807e+00  1.45487385e+01  3.05439224e+01]
 [-4.87411880e+00 -1.40427647e+01 -4.48717546e+00]
 [-8.23424625e+00  3.17639065e+00 -3.62416115e+01]
 [ 1.78261414e+01  3.83914971e+00 -7.89473581e+00]
 [ 7.09024763e+00  7.29508114e+00  2.85714006e+00]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="cvar-vs-variance">
<h2>CVaR vs variance<a class="headerlink" href="#cvar-vs-variance" title="Link to this heading">#</a></h2>
<p>Variance measures average deviation from the mean – it penalizes upside and downside equally.</p>
<p>CVaR (Conditional Value at Risk) measures the expected loss in the worst <span class="math notranslate nohighlight">\(\alpha\%\)</span> of scenarios.
For <span class="math notranslate nohighlight">\(\alpha = 0.05\)</span> (95% confidence), CVaR answers: “What’s my average loss on the worst 5% of days?”</p>
<p>Key advantages of CVaR:</p>
<ul class="simple">
<li><p>Focuses on tail risk (extreme losses) rather than general volatility</p></li>
<li><p>Coherent risk measure (subadditive, convex)</p></li>
<li><p>Does not assume normally distributed returns</p></li>
<li><p>More robust to outliers than variance</p></li>
</ul>
</section>
<section id="cvar-formulation">
<h2>CVaR formulation<a class="headerlink" href="#cvar-formulation" title="Link to this heading">#</a></h2>
<p>The CVaR optimization uses the Rockafellar-Uryasev formulation:</p>
<div class="math notranslate nohighlight">
\[\text{CVaR}_\alpha = \min_{\zeta} \left[ \zeta + \frac{1}{\alpha T} \sum_{t=1}^T \max(-w^\top r_t - \zeta, 0) \right]\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(w\)</span> = portfolio weights</p></li>
<li><p><span class="math notranslate nohighlight">\(r_t\)</span> = returns in scenario <span class="math notranslate nohighlight">\(t\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\zeta\)</span> = VaR threshold (auxiliary variable)</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha\)</span> = tail probability (e.g., 0.05 for 95% CVaR)</p></li>
<li><p><span class="math notranslate nohighlight">\(T\)</span> = number of scenarios</p></li>
</ul>
<p>To handle the <span class="math notranslate nohighlight">\(\max(\cdot, 0)\)</span> term, we introduce slack variables <span class="math notranslate nohighlight">\(u_t \geq 0\)</span>:</p>
<div class="math notranslate nohighlight">
\[\min_{w, \zeta, u} \quad \zeta + \frac{1}{\alpha T} \sum_{t=1}^T u_t\]</div>
<p>subject to:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(u_t \geq -w^\top r_t - \zeta\)</span> (loss exceeds VaR)</p></li>
<li><p><span class="math notranslate nohighlight">\(u_t \geq 0\)</span> (slack non-negativity)</p></li>
<li><p><span class="math notranslate nohighlight">\(\sum_i w_i = 1\)</span> (budget constraint)</p></li>
<li><p><span class="math notranslate nohighlight">\(w_i \geq 0\)</span> (no short-selling)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># CVaR confidence level.</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 95% CVaR (worst 5% of scenarios)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WeightsVar</span><span class="p">(</span><span class="n">jaxls</span><span class="o">.</span><span class="n">Var</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Portfolio weights (3D vector).&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VaRVar</span><span class="p">(</span><span class="n">jaxls</span><span class="o">.</span><span class="n">Var</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Value-at-Risk threshold (scalar).&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SlackVar</span><span class="p">(</span><span class="n">jaxls</span><span class="o">.</span><span class="n">Var</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Slack variables for max(loss - VaR, 0) per scenario.&quot;&quot;&quot;</span>


<span class="n">weights_var</span> <span class="o">=</span> <span class="n">WeightsVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">var_var</span> <span class="o">=</span> <span class="n">VaRVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">slack_var</span> <span class="o">=</span> <span class="n">SlackVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cvar_objective</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var_v</span><span class="p">:</span> <span class="n">VaRVar</span><span class="p">,</span>
    <span class="n">slack_v</span><span class="p">:</span> <span class="n">SlackVar</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">num_scenarios</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CVaR objective: VaR + (1/alpha) * mean(slack).</span>

<span class="sd">    Since this is the only cost term, the solver minimizes CVaR^2. For a</span>
<span class="sd">    non-negative scalar, min(CVaR^2) has the same minimizer as min(CVaR).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_threshold</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var_v</span><span class="p">]</span>
    <span class="n">slack</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">slack_v</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">var_threshold</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">slack</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">num_scenarios</span><span class="p">)</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_geq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">slack_lower_bound</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">weights_v</span><span class="p">:</span> <span class="n">WeightsVar</span><span class="p">,</span>
    <span class="n">var_v</span><span class="p">:</span> <span class="n">VaRVar</span><span class="p">,</span>
    <span class="n">slack_v</span><span class="p">:</span> <span class="n">SlackVar</span><span class="p">,</span>
    <span class="n">scenario_returns</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constraint: u_t &gt;= -w&#39;r_t - zeta (slack captures excess loss).&quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">weights_v</span><span class="p">]</span>
    <span class="n">var_threshold</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var_v</span><span class="p">]</span>
    <span class="n">slack</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">slack_v</span><span class="p">]</span>
    <span class="c1"># Portfolio return for each scenario.</span>
    <span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">scenario_returns</span> <span class="o">@</span> <span class="n">weights</span>
    <span class="c1"># Loss = negative return.</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">portfolio_returns</span>
    <span class="c1"># u_t &gt;= loss_t - VaR.</span>
    <span class="k">return</span> <span class="n">slack</span> <span class="o">-</span> <span class="p">(</span><span class="n">losses</span> <span class="o">-</span> <span class="n">var_threshold</span><span class="p">)</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_geq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">slack_nonneg</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">slack_v</span><span class="p">:</span> <span class="n">SlackVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constraint: u_t &gt;= 0.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">slack_v</span><span class="p">]</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_eq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">budget_constraint</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">weights_v</span><span class="p">:</span> <span class="n">WeightsVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weights must sum to 1 (fully invested).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">weights_v</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.0</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_geq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">no_short_constraint</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">weights_v</span><span class="p">:</span> <span class="n">WeightsVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;No short-selling: weights &gt;= 0.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">weights_v</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="solving">
<h2>Solving<a class="headerlink" href="#solving" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">costs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cvar_objective</span><span class="p">(</span><span class="n">var_var</span><span class="p">,</span> <span class="n">slack_var</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">num_scenarios</span><span class="p">),</span>
    <span class="n">slack_lower_bound</span><span class="p">(</span><span class="n">weights_var</span><span class="p">,</span> <span class="n">var_var</span><span class="p">,</span> <span class="n">slack_var</span><span class="p">,</span> <span class="n">returns</span><span class="p">),</span>
    <span class="n">slack_nonneg</span><span class="p">(</span><span class="n">slack_var</span><span class="p">),</span>
    <span class="n">budget_constraint</span><span class="p">(</span><span class="n">weights_var</span><span class="p">),</span>
    <span class="n">no_short_constraint</span><span class="p">(</span><span class="n">weights_var</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># Build the problem.</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">LeastSquaresProblem</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="p">[</span><span class="n">weights_var</span><span class="p">,</span> <span class="n">var_var</span><span class="p">,</span> <span class="n">slack_var</span><span class="p">])</span>

<span class="c1"># Visualize the problem structure structure.</span>
<span class="n">problem</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="500"
            src="data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDxzdHlsZT4KICAgICAgICBib2R5IHsgbWFyZ2luOiAwOyBvdmVyZmxvdzogaGlkZGVuOyB9CiAgICAgICAgI2NvbnRhaW5lciB7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMHZoOyBwb3NpdGlvbjogcmVsYXRpdmU7IH0KICAgICAgICBjYW52YXMgeyBkaXNwbGF5OiBibG9jazsgd2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsgfQogICAgICAgIC5zdGF0dXMgeyBwb3NpdGlvbjogYWJzb2x1dGU7IGJvdHRvbTogNXB4OyByaWdodDogMTBweDsgZm9udC1zaXplOiAxMHB4OyBjb2xvcjogIzY2NjsgZm9udC1mYW1pbHk6IEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWY7IGJhY2tncm91bmQ6IHJnYmEoMjU1LDI1NSwyNTUsMC44KTsgcGFkZGluZzogMnB4IDVweDsgYm9yZGVyLXJhZGl1czogM3B4OyB9CiAgICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5PgogICAgPGRpdiBpZD0iY29udGFpbmVyIj4KICAgICAgICA8Y2FudmFzPjwvY2FudmFzPgogICAgICAgIDxkaXYgY2xhc3M9InN0YXR1cyI+NSBjb3N0cywgMyB2YXJpYWJsZXM8L2Rpdj4KICAgIDwvZGl2PgogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vZDNqcy5vcmcvZDMudjcubWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQ+CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IHsibm9kZXMiOiBbeyJpZCI6ICJ2YXJfMCIsICJsYWJlbCI6ICJWYVJWYXIoMCkiLCAidHlwZSI6ICJ2YXJpYWJsZSIsICJ2YXJfdHlwZSI6ICJWYVJWYXIiLCAiZmlsbCI6ICIjY2NjY2ZmIiwgInN0cm9rZSI6ICIjNjY2NmNjIn0sIHsiaWQiOiAidmFyXzEiLCAibGFiZWwiOiAiU2xhY2tWYXIoMCkiLCAidHlwZSI6ICJ2YXJpYWJsZSIsICJ2YXJfdHlwZSI6ICJTbGFja1ZhciIsICJmaWxsIjogIiNmZmNjY2MiLCAic3Ryb2tlIjogIiNjYzY2NjYifSwgeyJpZCI6ICJ2YXJfMiIsICJsYWJlbCI6ICJXZWlnaHRzVmFyKDApIiwgInR5cGUiOiAidmFyaWFibGUiLCAidmFyX3R5cGUiOiAiV2VpZ2h0c1ZhciIsICJmaWxsIjogIiNjY2ZmY2MiLCAic3Ryb2tlIjogIiM2NmNjNjYifSwgeyJpZCI6ICJjb3N0XzAiLCAibGFiZWwiOiAiY3Zhcl9vYmplY3RpdmUiLCAidHlwZSI6ICJjb3N0IiwgImtpbmQiOiAibDJfc3F1YXJlZCIsICJmaWxsIjogIiNhOGQ1ZmYiLCAic3Ryb2tlIjogIiM0YTkwZDkifSwgeyJpZCI6ICJjb3N0XzEiLCAibGFiZWwiOiAic2xhY2tfbG93ZXJfYm91bmQiLCAidHlwZSI6ICJjb3N0IiwgImtpbmQiOiAiY29uc3RyYWludF9nZXFfemVybyIsICJmaWxsIjogIiNmZmE4ZTQiLCAic3Ryb2tlIjogIiNkOTRhYTgifSwgeyJpZCI6ICJjb3N0XzIiLCAibGFiZWwiOiAic2xhY2tfbm9ubmVnIiwgInR5cGUiOiAiY29zdCIsICJraW5kIjogImNvbnN0cmFpbnRfZ2VxX3plcm8iLCAiZmlsbCI6ICIjZmZhOGU0IiwgInN0cm9rZSI6ICIjZDk0YWE4In0sIHsiaWQiOiAiY29zdF8zIiwgImxhYmVsIjogImJ1ZGdldF9jb25zdHJhaW50IiwgInR5cGUiOiAiY29zdCIsICJraW5kIjogImNvbnN0cmFpbnRfZXFfemVybyIsICJmaWxsIjogIiNhOGZmYTgiLCAic3Ryb2tlIjogIiM0YWQ5NGEifSwgeyJpZCI6ICJjb3N0XzQiLCAibGFiZWwiOiAibm9fc2hvcnRfY29uc3RyYWludCIsICJ0eXBlIjogImNvc3QiLCAia2luZCI6ICJjb25zdHJhaW50X2dlcV96ZXJvIiwgImZpbGwiOiAiI2ZmYThlNCIsICJzdHJva2UiOiAiI2Q5NGFhOCJ9XSwgImxpbmtzIjogW3sic291cmNlIjogImNvc3RfMCIsICJ0YXJnZXQiOiAidmFyXzAifSwgeyJzb3VyY2UiOiAiY29zdF8wIiwgInRhcmdldCI6ICJ2YXJfMSJ9LCB7InNvdXJjZSI6ICJjb3N0XzEiLCAidGFyZ2V0IjogInZhcl8yIn0sIHsic291cmNlIjogImNvc3RfMSIsICJ0YXJnZXQiOiAidmFyXzAifSwgeyJzb3VyY2UiOiAiY29zdF8xIiwgInRhcmdldCI6ICJ2YXJfMSJ9LCB7InNvdXJjZSI6ICJjb3N0XzIiLCAidGFyZ2V0IjogInZhcl8xIn0sIHsic291cmNlIjogImNvc3RfMyIsICJ0YXJnZXQiOiAidmFyXzIifSwgeyJzb3VyY2UiOiAiY29zdF80IiwgInRhcmdldCI6ICJ2YXJfMiJ9XSwgInRydW5jYXRlZCI6IGZhbHNlfTsKICAgICAgICBjb25zdCBjb250YWluZXIgPSBkMy5zZWxlY3QoIiNjb250YWluZXIiKTsKICAgICAgICBjb25zdCBjYW52YXMgPSBjb250YWluZXIuc2VsZWN0KCJjYW52YXMiKS5ub2RlKCk7CiAgICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CgogICAgLy8gR2V0IGFjdHVhbCBjb250YWluZXIgZGltZW5zaW9ucy4KICAgIGNvbnN0IHJlY3QgPSBjb250YWluZXIubm9kZSgpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgY29uc3Qgd2lkdGggPSByZWN0LndpZHRoOwogICAgY29uc3QgaGVpZ2h0ID0gcmVjdC5oZWlnaHQ7CgogICAgLy8gTm9kZSBzaXppbmcuCiAgICBjb25zdCB2YXJSeCA9IDQ1LCB2YXJSeSA9IDE0OyAgLy8gRWxsaXBzZSByYWRpaSBmb3IgdmFyaWFibGVzLgogICAgY29uc3QgY29zdFcgPSA5MCwgY29zdEggPSAyMjsgICAvLyBSZWN0IHNpemUgZm9yIGNvc3RzLgoKICAgIC8vIFNldCB1cCBoaWdoLURQSSBjYW52YXMuCiAgICBjb25zdCBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxOwogICAgY2FudmFzLndpZHRoID0gd2lkdGggKiBkcHI7CiAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0ICogZHByOwogICAgY3R4LnNjYWxlKGRwciwgZHByKTsKCiAgICAvLyBUcmFjayB0cmFuc2Zvcm0gZm9yIHpvb20vcGFuLgogICAgbGV0IHRyYW5zZm9ybSA9IGQzLnpvb21JZGVudGl0eTsKCiAgICAvLyBDcmVhdGUgZm9yY2Ugc2ltdWxhdGlvbi4KICAgIGNvbnN0IHNpbXVsYXRpb24gPSBkMy5mb3JjZVNpbXVsYXRpb24oZGF0YS5ub2RlcykKICAgICAgICAuZm9yY2UoImxpbmsiLCBkMy5mb3JjZUxpbmsoZGF0YS5saW5rcykuaWQoZCA9PiBkLmlkKS5kaXN0YW5jZSg2MCkpCiAgICAgICAgLmZvcmNlKCJjaGFyZ2UiLCBkMy5mb3JjZU1hbnlCb2R5KCkuc3RyZW5ndGgoLTE1MCkuZGlzdGFuY2VNYXgoMjUwKSkKICAgICAgICAuZm9yY2UoImNlbnRlciIsIGQzLmZvcmNlQ2VudGVyKHdpZHRoIC8gMiwgaGVpZ2h0IC8gMikpCiAgICAgICAgLmZvcmNlKCJjb2xsaXNpb24iLCBkMy5mb3JjZUNvbGxpZGUoKS5yYWRpdXMoMzUpKTsKCiAgICAvLyBEcmFnIHN0YXRlLgogICAgbGV0IGRyYWdOb2RlID0gbnVsbDsKCiAgICAvLyBGaW5kIG5vZGUgYXQgcG9zaXRpb24uCiAgICBmdW5jdGlvbiBub2RlQXQoeCwgeSkgewogICAgICAgIGNvbnN0IHR4ID0gKHggLSB0cmFuc2Zvcm0ueCkgLyB0cmFuc2Zvcm0uazsKICAgICAgICBjb25zdCB0eSA9ICh5IC0gdHJhbnNmb3JtLnkpIC8gdHJhbnNmb3JtLms7CiAgICAgICAgZm9yIChsZXQgaSA9IGRhdGEubm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgY29uc3QgZCA9IGRhdGEubm9kZXNbaV07CiAgICAgICAgICAgIGNvbnN0IGR4ID0gdHggLSBkLng7CiAgICAgICAgICAgIGNvbnN0IGR5ID0gdHkgLSBkLnk7CiAgICAgICAgICAgIGlmIChkLnR5cGUgPT09ICJ2YXJpYWJsZSIpIHsKICAgICAgICAgICAgICAgIGlmICgoZHgqZHgpLyh2YXJSeCp2YXJSeCkgKyAoZHkqZHkpLyh2YXJSeSp2YXJSeSkgPCAxKSByZXR1cm4gZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhkeCkgPCBjb3N0Vy8yICYmIE1hdGguYWJzKGR5KSA8IGNvc3RILzIpIHJldHVybiBkOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICBjdHguY2xlYXJSZWN0KDAsIDAsIHdpZHRoLCBoZWlnaHQpOwogICAgICAgIGN0eC50cmFuc2xhdGUodHJhbnNmb3JtLngsIHRyYW5zZm9ybS55KTsKICAgICAgICBjdHguc2NhbGUodHJhbnNmb3JtLmssIHRyYW5zZm9ybS5rKTsKCiAgICAgICAgLy8gRHJhdyBsaW5rcy4KICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSAiIzk5OSI7CiAgICAgICAgY3R4Lmdsb2JhbEFscGhhID0gMC42OwogICAgICAgIGN0eC5saW5lV2lkdGggPSAxLjUgLyB0cmFuc2Zvcm0uazsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgZGF0YS5saW5rcy5mb3JFYWNoKGQgPT4gewogICAgICAgICAgICBjdHgubW92ZVRvKGQuc291cmNlLngsIGQuc291cmNlLnkpOwogICAgICAgICAgICBjdHgubGluZVRvKGQudGFyZ2V0LngsIGQudGFyZ2V0LnkpOwogICAgICAgIH0pOwogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICBjdHguZ2xvYmFsQWxwaGEgPSAxLjA7CgogICAgICAgIC8vIERyYXcgbm9kZXMuCiAgICAgICAgZGF0YS5ub2Rlcy5mb3JFYWNoKGQgPT4gewogICAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgICBjdHgudHJhbnNsYXRlKGQueCwgZC55KTsKCiAgICAgICAgICAgIGlmIChkLnR5cGUgPT09ICJ2YXJpYWJsZSIpIHsKICAgICAgICAgICAgICAgIC8vIEVsbGlwc2UgZm9yIHZhcmlhYmxlcy4KICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgIGN0eC5lbGxpcHNlKDAsIDAsIHZhclJ4LCB2YXJSeSwgMCwgMCwgMiAqIE1hdGguUEkpOwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGQuZmlsbDsKICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBkLnN0cm9rZTsKICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAxLjUgLyB0cmFuc2Zvcm0uazsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFJvdW5kZWQgcmVjdCBmb3IgY29zdHMuCiAgICAgICAgICAgICAgICBjb25zdCB3ID0gY29zdFcsIGggPSBjb3N0SCwgciA9IDQ7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgubW92ZVRvKC13LzIgKyByLCAtaC8yKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8ody8yIC0gciwgLWgvMik7CiAgICAgICAgICAgICAgICBjdHgucXVhZHJhdGljQ3VydmVUbyh3LzIsIC1oLzIsIHcvMiwgLWgvMiArIHIpOwogICAgICAgICAgICAgICAgY3R4LmxpbmVUbyh3LzIsIGgvMiAtIHIpOwogICAgICAgICAgICAgICAgY3R4LnF1YWRyYXRpY0N1cnZlVG8ody8yLCBoLzIsIHcvMiAtIHIsIGgvMik7CiAgICAgICAgICAgICAgICBjdHgubGluZVRvKC13LzIgKyByLCBoLzIpOwogICAgICAgICAgICAgICAgY3R4LnF1YWRyYXRpY0N1cnZlVG8oLXcvMiwgaC8yLCAtdy8yLCBoLzIgLSByKTsKICAgICAgICAgICAgICAgIGN0eC5saW5lVG8oLXcvMiwgLWgvMiArIHIpOwogICAgICAgICAgICAgICAgY3R4LnF1YWRyYXRpY0N1cnZlVG8oLXcvMiwgLWgvMiwgLXcvMiArIHIsIC1oLzIpOwogICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGQuZmlsbDsKICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBkLnN0cm9rZTsKICAgICAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAxLjUgLyB0cmFuc2Zvcm0uazsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gRHJhdyBsYWJlbC4KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICIjMDAwIjsKICAgICAgICAgICAgY3R4LmZvbnQgPSAiOXB4IEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWYiOwogICAgICAgICAgICBjdHgudGV4dEFsaWduID0gImNlbnRlciI7CiAgICAgICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAibWlkZGxlIjsKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGQubGFiZWwsIDAsIDApOwoKICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gRHJhdyBsZWdlbmQuCiAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICBkcmF3TGVnZW5kKCk7CiAgICB9CgogICAgZnVuY3Rpb24gZHJhd0xlZ2VuZCgpIHsKICAgICAgICAvLyBCdWlsZCBsZWdlbmQgZHluYW1pY2FsbHkgZnJvbSBhY3R1YWwgbm9kZXMuCiAgICAgICAgY29uc3QgbGVnZW5kRGF0YSA9IFtdOwoKICAgICAgICAvLyBDb2xsZWN0IHVuaXF1ZSBjb3N0IGtpbmRzLgogICAgICAgIGNvbnN0IGNvc3RLaW5kTGFiZWxzID0gewogICAgICAgICAgICAibDJfc3F1YXJlZCI6ICJDb3N0IChMMikiLAogICAgICAgICAgICAiY29uc3RyYWludF9lcV96ZXJvIjogIkVxdWFsaXR5IiwKICAgICAgICAgICAgImNvbnN0cmFpbnRfbGVxX3plcm8iOiAiSW5lcXVhbGl0eSAo4omkKSIsCiAgICAgICAgICAgICJjb25zdHJhaW50X2dlcV96ZXJvIjogIkluZXF1YWxpdHkgKOKJpSkiCiAgICAgICAgfTsKICAgICAgICBjb25zdCBzZWVuQ29zdEtpbmRzID0gbmV3IFNldCgpOwogICAgICAgIGRhdGEubm9kZXMuZmlsdGVyKG4gPT4gbi50eXBlID09PSAiY29zdCIpLmZvckVhY2gobiA9PiBzZWVuQ29zdEtpbmRzLmFkZChuLmtpbmQpKTsKICAgICAgICBmb3IgKGNvbnN0IGtpbmQgb2YgWyJsMl9zcXVhcmVkIiwgImNvbnN0cmFpbnRfZXFfemVybyIsICJjb25zdHJhaW50X2xlcV96ZXJvIiwgImNvbnN0cmFpbnRfZ2VxX3plcm8iXSkgewogICAgICAgICAgICBpZiAoc2VlbkNvc3RLaW5kcy5oYXMoa2luZCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBkYXRhLm5vZGVzLmZpbmQobiA9PiBuLnR5cGUgPT09ICJjb3N0IiAmJiBuLmtpbmQgPT09IGtpbmQpOwogICAgICAgICAgICAgICAgbGVnZW5kRGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBsYWJlbDogY29zdEtpbmRMYWJlbHNba2luZF0sCiAgICAgICAgICAgICAgICAgICAgZmlsbDogbm9kZS5maWxsLAogICAgICAgICAgICAgICAgICAgIHN0cm9rZTogbm9kZS5zdHJva2UsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogImNvc3QiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ29sbGVjdCB1bmlxdWUgdmFyaWFibGUgdHlwZXMuCiAgICAgICAgY29uc3Qgc2VlblZhclR5cGVzID0gbmV3IE1hcCgpOyAgLy8gdmFyX3R5cGUgLT4ge2ZpbGwsIHN0cm9rZX0KICAgICAgICBkYXRhLm5vZGVzLmZpbHRlcihuID0+IG4udHlwZSA9PT0gInZhcmlhYmxlIikuZm9yRWFjaChuID0+IHsKICAgICAgICAgICAgaWYgKCFzZWVuVmFyVHlwZXMuaGFzKG4udmFyX3R5cGUpKSB7CiAgICAgICAgICAgICAgICBzZWVuVmFyVHlwZXMuc2V0KG4udmFyX3R5cGUsIHsgZmlsbDogbi5maWxsLCBzdHJva2U6IG4uc3Ryb2tlIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZm9yIChjb25zdCBbdmFyVHlwZSwgY29sb3JzXSBvZiBzZWVuVmFyVHlwZXMpIHsKICAgICAgICAgICAgbGVnZW5kRGF0YS5wdXNoKHsKICAgICAgICAgICAgICAgIGxhYmVsOiB2YXJUeXBlLAogICAgICAgICAgICAgICAgZmlsbDogY29sb3JzLmZpbGwsCiAgICAgICAgICAgICAgICBzdHJva2U6IGNvbG9ycy5zdHJva2UsCiAgICAgICAgICAgICAgICB0eXBlOiAidmFyaWFibGUiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICBjdHgudHJhbnNsYXRlKDEwLCAxMCk7CgogICAgICAgIGxlZ2VuZERhdGEuZm9yRWFjaCgoZCwgaSkgPT4gewogICAgICAgICAgICBjb25zdCB5ID0gaSAqIDE4OwogICAgICAgICAgICBpZiAoZC50eXBlID09PSAidmFyaWFibGUiKSB7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHguZWxsaXBzZSgxMiwgeSArIDYsIDEyLCA2LCAwLCAwLCAyICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZC5maWxsOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGQuc3Ryb2tlOwogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICBjdHgucm91bmRSZWN0KDAsIHksIDI0LCAxMiwgMik7CiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZC5maWxsOwogICAgICAgICAgICAgICAgY3R4LmZpbGwoKTsKICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGQuc3Ryb2tlOwogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7CiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICIjMDAwIjsKICAgICAgICAgICAgY3R4LmZvbnQgPSAiOXB4IEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWYiOwogICAgICAgICAgICBjdHgudGV4dEFsaWduID0gImxlZnQiOwogICAgICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gIm1pZGRsZSI7CiAgICAgICAgICAgIGN0eC5maWxsVGV4dChkLmxhYmVsLCAzMCwgeSArIDYpOwogICAgICAgIH0pOwoKICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgfQoKICAgIHNpbXVsYXRpb24ub24oInRpY2siLCBkcmF3KTsKCiAgICAvLyBab29tIGJlaGF2aW9yIHdpdGggZmlsdGVyIHRvIGFsbG93IG5vZGUgZHJhZ2dpbmcuCiAgICBjb25zdCB6b29tID0gZDMuem9vbSgpCiAgICAgICAgLnNjYWxlRXh0ZW50KFswLjEsIDRdKQogICAgICAgIC5maWx0ZXIoKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIC8vIEJsb2NrIHpvb20gaWYgY2xpY2tpbmcgb24gYSBub2RlIChhbGxvdyBub2RlIGRyYWcgaW5zdGVhZCkuCiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAibW91c2Vkb3duIikgewogICAgICAgICAgICAgICAgY29uc3QgW3gsIHldID0gZDMucG9pbnRlcihldmVudCk7CiAgICAgICAgICAgICAgICBpZiAobm9kZUF0KHgsIHkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSkKICAgICAgICAub24oInpvb20iLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgdHJhbnNmb3JtID0gZXZlbnQudHJhbnNmb3JtOwogICAgICAgICAgICBkcmF3KCk7CiAgICAgICAgfSk7CgogICAgZDMuc2VsZWN0KGNhbnZhcykKICAgICAgICAuY2FsbCh6b29tKQogICAgICAgIC5vbigibW91c2Vkb3duLmRyYWciLCAoZXZlbnQpID0+IHsKICAgICAgICAgICAgY29uc3QgW3gsIHldID0gZDMucG9pbnRlcihldmVudCk7CiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSBub2RlQXQoeCwgeSk7CiAgICAgICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgICAgICBkcmFnTm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgICBzaW11bGF0aW9uLmFscGhhVGFyZ2V0KDAuMykucmVzdGFydCgpOwogICAgICAgICAgICAgICAgZHJhZ05vZGUuZnggPSBkcmFnTm9kZS54OwogICAgICAgICAgICAgICAgZHJhZ05vZGUuZnkgPSBkcmFnTm9kZS55OwogICAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgICAub24oIm1vdXNlbW92ZS5kcmFnIiwgKGV2ZW50KSA9PiB7CiAgICAgICAgICAgIGlmIChkcmFnTm9kZSkgewogICAgICAgICAgICAgICAgY29uc3QgW3gsIHldID0gZDMucG9pbnRlcihldmVudCk7CiAgICAgICAgICAgICAgICBkcmFnTm9kZS5meCA9IHRyYW5zZm9ybS5pbnZlcnRYKHgpOwogICAgICAgICAgICAgICAgZHJhZ05vZGUuZnkgPSB0cmFuc2Zvcm0uaW52ZXJ0WSh5KTsKICAgICAgICAgICAgICAgIGRyYXcoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICAgLm9uKCJtb3VzZXVwLmRyYWcgbW91c2VsZWF2ZS5kcmFnIiwgKCkgPT4gewogICAgICAgICAgICBpZiAoZHJhZ05vZGUpIHsKICAgICAgICAgICAgICAgIHNpbXVsYXRpb24uYWxwaGFUYXJnZXQoMCk7CiAgICAgICAgICAgICAgICBkcmFnTm9kZS5meCA9IG51bGw7CiAgICAgICAgICAgICAgICBkcmFnTm9kZS5meSA9IG51bGw7CiAgICAgICAgICAgICAgICBkcmFnTm9kZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSW5pdGlhbCBkcmF3LgogICAgICAgIGRyYXcoKTsKICAgIH0pKCk7CiAgICA8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Analyze and solve.</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>

<span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;dense_cholesky&quot;</span><span class="p">,</span>
    <span class="n">termination</span><span class="o">=</span><span class="n">jaxls</span><span class="o">.</span><span class="n">TerminationConfig</span><span class="p">(</span><span class="n">cost_tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 5 terms and 3 variables: 1 costs, 1 eq_zero, 0 leq_zero, 3 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 1 costs, 2 variables each: cvar_objective
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 3 variables each: augmented_slack_lower_bound
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 1 variables each: augmented_slack_nonneg
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_eq_zero), 1 variables each: augmented_budget_constraint
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 1 variables each: augmented_no_short_constraint
<span class=" -Color -Color-Bold">INFO    </span> | Augmented Lagrangian: initial snorm=1.3766e-01, csupn=1.3766e-01, max_rho=1.0000e+01, constraint_dim=28
<span class=" -Color -Color-Bold">INFO    </span> |  step #0: cost=0.0000 lambd=0.0005
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.39280 (avg 0.03273)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=5.26e+00 cost_prev=0.3928 cost_new=0.0269
<span class=" -Color -Color-Bold">INFO    </span> |  step #1: cost=0.0000 lambd=0.0003
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #2: cost=0.0000 lambd=0.0005
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #3: cost=0.0000 lambd=0.0010
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #4: cost=0.0000 lambd=0.0020
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #5: cost=0.0000 lambd=0.0040
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #6: cost=0.0000 lambd=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #7: cost=0.0000 lambd=0.0160
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #8: cost=0.0000 lambd=0.0320
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #9: cost=0.0000 lambd=0.0640
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #10: cost=0.0000 lambd=0.1280
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02689 (avg 0.00224)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=6.65e-01 cost_prev=0.0269 cost_new=0.0264
<span class=" -Color -Color-Bold">INFO    </span> |  step #11: cost=0.0000 lambd=0.0640
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00002 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.02642 (avg 0.00220)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=6.18e-01 cost_prev=0.0264 cost_new=0.0071
<span class=" -Color -Color-Bold">INFO    </span> |  step #12: cost=0.0002 lambd=0.0320
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00021 (avg 0.00021)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00012 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00674 (avg 0.00056)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #13: cost=0.0002 lambd=0.0640
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00021 (avg 0.00021)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00012 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00674 (avg 0.00056)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=2.99e-01 cost_prev=0.0071 cost_new=0.0061
<span class=" -Color -Color-Bold">INFO    </span> |  step #14: cost=0.0004 lambd=0.0320
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00039 (avg 0.00039)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00010 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00558 (avg 0.00046)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #15: cost=0.0004 lambd=0.0640
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00039 (avg 0.00039)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00010 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00558 (avg 0.00046)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #16: cost=0.0004 lambd=0.1280
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00039 (avg 0.00039)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00010 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00558 (avg 0.00046)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #17: cost=0.0004 lambd=0.2560
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00039 (avg 0.00039)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00010 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00558 (avg 0.00046)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=2.52e-01 cost_prev=0.0061 cost_new=0.0053
<span class=" -Color -Color-Bold">INFO    </span> |  step #18: cost=0.0006 lambd=0.1280
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00056 (avg 0.00056)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00297 (avg 0.00025)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00175 (avg 0.00015)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=2.92e-01 cost_prev=0.0053 cost_new=0.0025
<span class=" -Color -Color-Bold">INFO    </span> |  step #19: cost=0.0006 lambd=0.0640
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00061 (avg 0.00061)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00003 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00185 (avg 0.00015)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=4.15e-03 cost_prev=0.0025 cost_new=0.0024
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=4.0531e-03, csupn=4.0531e-03, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #20: cost=0.0006 lambd=0.0320
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00059 (avg 0.00059)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.01135 (avg 0.00095)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=7.17e-01 cost_prev=0.0121 cost_new=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |  step #21: cost=0.0043 lambd=0.0160
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00431 (avg 0.00431)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00033 (avg 0.00003)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00332 (avg 0.00028)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=3.65e-04 cost_prev=0.0080 cost_new=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=3.7433e-03, csupn=3.7433e-03, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #22: cost=0.0043 lambd=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00431 (avg 0.00431)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00109 (avg 0.00009)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00880 (avg 0.00073)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=4.21e-01 cost_prev=0.0142 cost_new=0.0130
<span class=" -Color -Color-Bold">INFO    </span> |  step #23: cost=0.0072 lambd=0.0040
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00725 (avg 0.00725)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00014 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00558 (avg 0.00046)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=3.81e-04 cost_prev=0.0130 cost_new=0.0129
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=8.0387e-04, csupn=8.0387e-04, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #24: cost=0.0072 lambd=0.0020
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00721 (avg 0.00721)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00021 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00836 (avg 0.00070)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #25: cost=0.0072 lambd=0.0040
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00721 (avg 0.00721)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00021 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00836 (avg 0.00070)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #26: cost=0.0072 lambd=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00721 (avg 0.00721)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00021 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00836 (avg 0.00070)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #27: cost=0.0072 lambd=0.0160
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00721 (avg 0.00721)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00021 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00836 (avg 0.00070)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.48e-01 cost_prev=0.0158 cost_new=0.0156
<span class=" -Color -Color-Bold">INFO    </span> |  step #28: cost=0.0087 lambd=0.0080
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00872 (avg 0.00872)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00018 (avg 0.00002)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00671 (avg 0.00056)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=3.74e-02 cost_prev=0.0156 cost_new=0.0156
<span class=" -Color -Color-Bold">INFO    </span> |  step #29: cost=0.0087 lambd=0.0040
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00874 (avg 0.00874)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00015 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00671 (avg 0.00056)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=False ATb_norm=1.11e-05 cost_prev=0.0156 cost_new=0.0156
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=3.5812e-04, csupn=3.5812e-04, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #30: cost=0.0087 lambd=0.0040
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00874 (avg 0.00874)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00016 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00797 (avg 0.00066)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=6.58e-02 cost_prev=0.0169 cost_new=0.0168
<span class=" -Color -Color-Bold">INFO    </span> |  step #31: cost=0.0094 lambd=0.0020
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00944 (avg 0.00944)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00016 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00724 (avg 0.00060)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.97e-05 cost_prev=0.0168 cost_new=0.0168
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=1.5261e-04, csupn=1.5261e-04, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #32: cost=0.0094 lambd=0.0010
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00944 (avg 0.00944)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00780 (avg 0.00065)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=2.80e-02 cost_prev=0.0174 cost_new=0.0174
<span class=" -Color -Color-Bold">INFO    </span> |  step #33: cost=0.0098 lambd=0.0005
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00976 (avg 0.00976)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00016 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00748 (avg 0.00062)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.71e-06 cost_prev=0.0174 cost_new=0.0174
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=6.6933e-05, csupn=6.6933e-05, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #34: cost=0.0098 lambd=0.0003
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00976 (avg 0.00976)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00773 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.23e-02 cost_prev=0.0177 cost_new=0.0177
<span class=" -Color -Color-Bold">INFO    </span> |  step #35: cost=0.0099 lambd=0.0001
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00990 (avg 0.00990)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00759 (avg 0.00063)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.94e-06 cost_prev=0.0177 cost_new=0.0177
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=2.9420e-05, csupn=2.9420e-05, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #36: cost=0.0099 lambd=0.0001
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00990 (avg 0.00990)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00770 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=5.41e-03 cost_prev=0.0178 cost_new=0.0178
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=1.2926e-05, csupn=1.2926e-05, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #37: cost=0.0100 lambd=0.0000
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00996 (avg 0.00996)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=2.38e-03 cost_prev=0.0178 cost_new=0.0178
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=5.6801e-06, csupn=5.6801e-06, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #38: cost=0.0100 lambd=0.0000
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.00999 (avg 0.00999)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=1.04e-03 cost_prev=0.0178 cost_new=0.0178
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=2.4961e-06, csupn=2.4961e-06, max_rho=4.0000e+01
<span class=" -Color -Color-Bold">INFO    </span> |  step #39: cost=0.0100 lambd=0.0000
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #40: cost=0.0100 lambd=0.0000
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #41: cost=0.0100 lambd=0.0000
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #42: cost=0.0100 lambd=0.0001
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #43: cost=0.0100 lambd=0.0002
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |  step #44: cost=0.0100 lambd=0.0003
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00768 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=True ATb_norm=4.58e-04 cost_prev=0.0178 cost_new=0.0178
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=1.0965e-06, csupn=1.0965e-06, max_rho=1.6000e+02
<span class=" -Color -Color-Bold">INFO    </span> |  step #45: cost=0.0100 lambd=0.0002
<span class=" -Color -Color-Bold">INFO    </span> |      - cvar_objective(1): 0.01000 (avg 0.01000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_lower_bound(1): 0.00017 (avg 0.00001)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_slack_nonneg(1): 0.00767 (avg 0.00064)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_budget_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      - augmented_no_short_constraint(1): 0.00000 (avg 0.00000)
<span class=" -Color -Color-Bold">INFO    </span> |      accepted=False ATb_norm=2.06e-04 cost_prev=0.0178 cost_new=0.0178
<span class=" -Color -Color-Bold">INFO    </span> |  AL update: snorm=1.0965e-06, csupn=1.0965e-06, max_rho=6.4000e+02
<span class=" -Color -Color-Bold">INFO    </span> | Terminated @ iteration #46: cost=0.0100 criteria=[0 1 0], term_deltas=2.3e-04,6.0e-05,1.6e-05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract solution.</span>
<span class="n">optimal_weights</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">weights_var</span><span class="p">]</span>
<span class="n">optimal_var</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="n">var_var</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Compute CVaR from the solution.</span>
<span class="n">portfolio_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">@</span> <span class="n">optimal_weights</span>
<span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">portfolio_returns</span>
<span class="c1"># CVaR is the mean of losses exceeding VaR.</span>
<span class="n">tail_losses</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">losses</span> <span class="o">&gt;=</span> <span class="n">optimal_var</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">cvar_value</span> <span class="o">=</span> <span class="n">optimal_var</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">losses</span> <span class="o">-</span> <span class="n">optimal_var</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
    <span class="n">alpha</span> <span class="o">*</span> <span class="n">num_scenarios</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== CVaR-Optimal Portfolio ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Alpha (tail probability): </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimal weights:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stock_names</span><span class="p">,</span> <span class="n">optimal_weights</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">VaR (95%): </span><span class="si">{</span><span class="n">optimal_var</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% monthly loss&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;CVaR (95%): </span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">cvar_value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% expected loss in worst </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> of scenarios&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== CVaR-Optimal Portfolio ===

Alpha (tail probability): 5%

Optimal weights:
  IBM: 13.2%

  WMT: 57.2%
  SEHI: 29.6%

VaR (95%): 10.00% monthly loss
CVaR (95%): 10.00% expected loss in worst 5% of scenarios
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparison-cvar-vs-mean-variance">
<h2>Comparison: CVaR vs mean-variance<a class="headerlink" href="#comparison-cvar-vs-mean-variance" title="Link to this heading">#</a></h2>
<p>Let’s compare the CVaR-optimal portfolio with a minimum-variance portfolio.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute covariance matrix for mean-variance comparison.</span>
<span class="n">expected_returns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">returns_centered</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">expected_returns</span>
<span class="n">covariance</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns_centered</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">returns_centered</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cov_chol</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">covariance</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MVWeightsVar</span><span class="p">(</span><span class="n">jaxls</span><span class="o">.</span><span class="n">Var</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Portfolio weights for mean-variance optimization.&quot;&quot;&quot;</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">variance_cost</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">MVWeightsVar</span><span class="p">,</span> <span class="n">cov_chol</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimize portfolio variance: ||L.T @ w||^2 = w.T @ cov @ w.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cov_chol</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_eq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mv_budget_constraint</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">MVWeightsVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weights must sum to 1.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.0</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;constraint_geq_zero&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mv_no_short_constraint</span><span class="p">(</span><span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">MVWeightsVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;No short-selling.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>


<span class="n">mv_weights_var</span> <span class="o">=</span> <span class="n">MVWeightsVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mv_costs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">variance_cost</span><span class="p">(</span><span class="n">mv_weights_var</span><span class="p">,</span> <span class="n">cov_chol</span><span class="p">),</span>
    <span class="n">mv_budget_constraint</span><span class="p">(</span><span class="n">mv_weights_var</span><span class="p">),</span>
    <span class="n">mv_no_short_constraint</span><span class="p">(</span><span class="n">mv_weights_var</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">mv_problem</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">LeastSquaresProblem</span><span class="p">(</span><span class="n">mv_costs</span><span class="p">,</span> <span class="p">[</span><span class="n">mv_weights_var</span><span class="p">])</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>
<span class="n">mv_solution</span> <span class="o">=</span> <span class="n">mv_problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;dense_cholesky&quot;</span><span class="p">,</span>
    <span class="n">termination</span><span class="o">=</span><span class="n">jaxls</span><span class="o">.</span><span class="n">TerminationConfig</span><span class="p">(</span><span class="n">cost_tolerance</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">mv_weights</span> <span class="o">=</span> <span class="n">mv_solution</span><span class="p">[</span><span class="n">mv_weights_var</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 3 terms and 1 variables: 1 costs, 1 eq_zero, 0 leq_zero, 1 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_eq_zero), 1 variables each: augmented_mv_budget_constraint
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 1 variables each: augmented_mv_no_short_constraint
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 1 costs, 1 variables each: variance_cost
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>


<span class="k">def</span><span class="w"> </span><span class="nf">compute_metrics</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute risk metrics for a portfolio.&quot;&quot;&quot;</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">@</span> <span class="n">weights</span>
    <span class="n">losses</span> <span class="o">=</span> <span class="o">-</span><span class="n">port_returns</span>

    <span class="c1"># Variance and std dev.</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">covariance</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">std_dev</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">))</span>

    <span class="c1"># VaR (95%) - the 95th percentile of losses.</span>
    <span class="n">sorted_losses</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
    <span class="n">var_95</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sorted_losses</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">num_scenarios</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">))])</span>

    <span class="c1"># CVaR (95%) - mean of losses exceeding VaR.</span>
    <span class="n">cvar_95</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
        <span class="n">var_95</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">losses</span> <span class="o">-</span> <span class="n">var_95</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">num_scenarios</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Expected return.</span>
    <span class="n">exp_return</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">expected_returns</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;std_dev&quot;</span><span class="p">:</span> <span class="n">std_dev</span><span class="p">,</span>
        <span class="s2">&quot;var_95&quot;</span><span class="p">:</span> <span class="n">var_95</span><span class="p">,</span>
        <span class="s2">&quot;cvar_95&quot;</span><span class="p">:</span> <span class="n">cvar_95</span><span class="p">,</span>
        <span class="s2">&quot;exp_return&quot;</span><span class="p">:</span> <span class="n">exp_return</span><span class="p">,</span>
    <span class="p">}</span>


<span class="n">cvar_metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">optimal_weights</span><span class="p">)</span>
<span class="n">mv_metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">mv_weights</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Metric&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;CVaR-Opt&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Min-Var&#39;</span><span class="si">:</span><span class="s2">&gt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Expected Return (monthly)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cvar_metrics</span><span class="p">[</span><span class="s1">&#39;exp_return&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">mv_metrics</span><span class="p">[</span><span class="s1">&#39;exp_return&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Std Dev (monthly)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cvar_metrics</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">mv_metrics</span><span class="p">[</span><span class="s1">&#39;std_dev&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;VaR 95% (monthly loss)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cvar_metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">mv_metrics</span><span class="p">[</span><span class="s1">&#39;var_95&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;CVaR 95% (monthly loss)&#39;</span><span class="si">:</span><span class="s2">&lt;25</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cvar_metrics</span><span class="p">[</span><span class="s1">&#39;cvar_95&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">% </span><span class="si">{</span><span class="n">mv_metrics</span><span class="p">[</span><span class="s1">&#39;cvar_95&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">&gt;11.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
Metric                        CVaR-Opt      Min-Var
==================================================
Expected Return (monthly)        2.99%        1.26%
Std Dev (monthly)               10.37%        7.71%
VaR 95% (monthly loss)          10.00%       12.33%
CVaR 95% (monthly loss)         10.00%       12.33%
==================================================
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#2196F3&quot;</span><span class="p">,</span> <span class="s2">&quot;#4CAF50&quot;</span><span class="p">,</span> <span class="s2">&quot;#FF9800&quot;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Portfolio Weights&quot;</span><span class="p">,</span> <span class="s2">&quot;Return Distribution&quot;</span><span class="p">),</span>
    <span class="n">column_widths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Left plot: Weight comparison.</span>
<span class="n">x_labels</span> <span class="o">=</span> <span class="n">stock_names</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">optimal_weights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CVaR-Optimal&quot;</span><span class="p">,</span>
        <span class="n">marker_color</span><span class="o">=</span><span class="s2">&quot;#E91E63&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">mv_weights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Min-Variance&quot;</span><span class="p">,</span>
        <span class="n">marker_color</span><span class="o">=</span><span class="s2">&quot;#3F51B5&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Right plot: Return distributions.</span>
<span class="n">cvar_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">@</span> <span class="n">optimal_weights</span>
<span class="n">mv_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">@</span> <span class="n">mv_weights</span>

<span class="c1"># Sort for visualization.</span>
<span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cvar_returns</span><span class="p">)</span>
<span class="n">scenario_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Scenario </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_scenarios</span><span class="p">)]</span>

<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_scenarios</span><span class="p">)),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">cvar_returns</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CVaR-Optimal Returns&quot;</span><span class="p">,</span>
        <span class="n">marker_color</span><span class="o">=</span><span class="s2">&quot;#E91E63&quot;</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_scenarios</span><span class="p">)),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">mv_returns</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Min-Variance Returns&quot;</span><span class="p">,</span>
        <span class="n">marker_color</span><span class="o">=</span><span class="s2">&quot;#3F51B5&quot;</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add VaR threshold line.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_hline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=-</span><span class="n">cvar_metrics</span><span class="p">[</span><span class="s2">&quot;var_95&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">line_dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">,</span>
    <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;#E91E63&quot;</span><span class="p">,</span>
    <span class="n">annotation_text</span><span class="o">=</span><span class="s2">&quot;CVaR VaR threshold&quot;</span><span class="p">,</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Asset&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Weight (%)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Scenario (sorted by return)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Monthly Return (%)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_plotlyjs</span><span class="o">=</span><span class="s2">&quot;cdn&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.3.0.min.js" integrity="sha256-bO3dS6yCpk9aK4gUpNELtCiDeSYvGYnK7jFI58NQnHI=" crossorigin="anonymous"></script>                <div id="9176ab9d-c858-411c-8d18-759a8afcc457" class="plotly-graph-div" style="height:400px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("9176ab9d-c858-411c-8d18-759a8afcc457")) {                    Plotly.newPlot(                        "9176ab9d-c858-411c-8d18-759a8afcc457",                        [{"marker":{"color":"#E91E63"},"name":"CVaR-Optimal","x":["IBM","WMT","SEHI"],"y":{"dtype":"f4","bdata":"AcdSQdrOZELF\u002fuxB"},"type":"bar","xaxis":"x","yaxis":"y"},{"marker":{"color":"#3F51B5"},"name":"Min-Variance","x":["IBM","WMT","SEHI"],"y":{"dtype":"f4","bdata":"uqt\u002fQcbvokJKWCNA"},"type":"bar","xaxis":"x","yaxis":"y"},{"marker":{"color":"#E91E63"},"name":"CVaR-Optimal Returns","opacity":0.7,"x":[0,1,2,3,4,5,6,7,8,9,10,11],"y":{"dtype":"f4","bdata":"WREgwfwQIMHzECDBgWmXwBoqZcBHKQ1AHYK+QLJeFkHFlyFBdYRkQTSrfUFxRINB"},"type":"bar","xaxis":"x2","yaxis":"y2"},{"marker":{"color":"#3F51B5"},"name":"Min-Variance Returns","opacity":0.7,"x":[0,1,2,3,4,5,6,7,8,9,10,11],"y":{"dtype":"f4","bdata":"eeI3wQiosT4tV0XB6haOwLftPb5uyrhAR8XkQNins0CAFC5BPwZVP67lxj+\u002fcDdB"},"type":"bar","xaxis":"x2","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.36000000000000004],"title":{"text":"Asset"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"Weight (%)"}},"xaxis2":{"anchor":"y2","domain":[0.4600000000000001,1.0],"title":{"text":"Scenario (sorted by return)"}},"yaxis2":{"anchor":"x2","domain":[0.0,1.0],"title":{"text":"Monthly Return (%)"}},"annotations":[{"font":{"size":16},"showarrow":false,"text":"Portfolio Weights","x":0.18000000000000002,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"Return Distribution","x":0.73,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"showarrow":false,"text":"CVaR VaR threshold","x":1,"xanchor":"right","xref":"x2 domain","y":-10.004235059022903,"yanchor":"bottom","yref":"y2"}],"shapes":[{"line":{"color":"#E91E63","dash":"dash"},"type":"line","x0":0,"x1":1,"xref":"x2 domain","y0":-10.004235059022903,"y1":-10.004235059022903,"yref":"y2"}],"margin":{"t":40,"b":40,"l":60,"r":40},"legend":{"orientation":"h","yanchor":"bottom","y":-0.25,"xanchor":"center","x":0.5},"barmode":"group","height":400},                        {"responsive": true}                    )                };            </script>        </div></div></div>
</div>
</section>
<section id="key-observations">
<h2>Key observations<a class="headerlink" href="#key-observations" title="Link to this heading">#</a></h2>
<p>The CVaR-optimal portfolio differs from the minimum-variance portfolio:</p>
<ol class="arabic simple">
<li><p>Different risk focus: CVaR optimization targets tail risk,
while minimum-variance treats all deviations equally.</p></li>
<li><p>Asset allocation: CVaR may allocate more to assets that have better
worst-case behavior, even if they have higher overall variance.</p></li>
<li><p>Scenario-based: CVaR uses historical scenarios directly, making no
normality assumptions about returns.</p></li>
</ol>
<p>For risk-averse investors concerned about extreme losses (e.g., pension funds,
insurance companies), CVaR optimization provides a more relevant risk measure
than variance.</p>
<p>For more details on constrained optimization in jaxls, see <a class="reference internal" href="../../../api/core/#jaxls.Cost" title="jaxls.Cost"><code class="xref py py-class docutils literal notranslate"><span class="pre">jaxls.Cost</span></code></a>
and <a class="reference internal" href="../../../api/core/#jaxls.LeastSquaresProblem" title="jaxls.LeastSquaresProblem"><code class="xref py py-class docutils literal notranslate"><span class="pre">jaxls.LeastSquaresProblem</span></code></a>.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../reparameterized_allocation/"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Reparameterized allocation</p>
      </div>
    </a>
    <a class="right-next"
       href="../black_litterman/"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Black-Litterman allocation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#historical-stock-data">Historical stock data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cvar-vs-variance">CVaR vs variance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cvar-formulation">CVaR formulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solving">Solving</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-cvar-vs-mean-variance">Comparison: CVaR vs mean-variance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#key-observations">Key observations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By brentyi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>