<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../genindex/"><link rel="search" title="Search" href="../../search/"><link rel="next" title="What’s traced?" href="../traced_vs_static/"><link rel="prev" title="Typed API" href="../typed_api/">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>Sparse matrices - jaxls</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=6517d2d4" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-code-background: #f4f4f4;
  --color-code-foreground: #000;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../"><div class="brand">jaxls</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a
  class="sidebar-brand"
  href="../../"
  style="margin-top: 0.75em"
>
  
  <span class="sidebar-brand-text">jaxls</span>

  
</a>

<div style="text-align: left; padding: 0 1em 1em 1em">
  <a href="https://github.com/brentyi/jaxls">
    <img src="https://img.shields.io/github/stars/brentyi/jaxls?style=social" alt="GitHub stars">
  </a>
</div><form class="sidebar-search-container" method="get" action="../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/basics/">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/tips_and_gotchas/">Tips and gotchas</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../guide/advanced/">Advanced</a><input aria-label="Toggle navigation of Advanced" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/advanced/non_euclidean/">Non-Euclidean variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/advanced/custom_jacobians/">Custom Jacobians</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/advanced/constraints/">Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/advanced/robust_costs/">Robust costs</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/mechanics/">Mechanics</a><input aria-label="Toggle navigation of Mechanics" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/mechanics/spring_equilibrium/">Spring equilibrium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/mechanics/cloth_draping/">Cloth draping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/mechanics/truss_analysis/">Truss analysis</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/vision/">Vision</a><input aria-label="Toggle navigation of Vision" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/vision/camera_calibration/">Camera calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/vision/pose_graph_2d/">SE(2) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/vision/pose_graph_3d/">SE(3) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/vision/bundle_adjustment/">Bundle adjustment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/vision/smplh_shape_fitting/">SMPL-H shape fitting</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/robotics/">Robotics</a><input aria-label="Toggle navigation of Robotics" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/inverse_kinematics/">Inverse kinematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/obstacle_avoidance/">Obstacle avoidance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/cart_pole_collocation/">Cart-pole (collocation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/cart_pole_shooting/">Cart-pole (shooting)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/cam_design/">Cam profile optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/robotics/imu_sensor_fusion/">IMU fusion + calibration</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples/portfolio/">Portfolio optimization</a><input aria-label="Toggle navigation of Portfolio optimization" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/portfolio/mean_variance/">Mean-variance allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/portfolio/manifold_allocation/">Manifold allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/portfolio/reparameterized_allocation/">Reparameterized allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/portfolio/cvar_optimization/">CVaR allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/portfolio/black_litterman/">Black-Litterman allocation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/core/">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/lie_group_variables/">Lie group variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/solver_config/">Solver configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../typed_api/">Typed API</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Sparse matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../traced_vs_static/">What’s traced?</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../_sources/design/sparse_matrices.ipynb.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="sparse-matrices">
<h1>Sparse matrices<a class="headerlink" href="#sparse-matrices" title="Link to this heading">¶</a></h1>
<p>jaxls solves nonlinear least squares using Levenberg-Marquardt, which is based on
the Gauss-Newton method.</p>
<p>This page discusses:</p>
<ul class="simple">
<li><p>The Gauss-Newton approximation and why Jacobian structure matters</p></li>
<li><p>jaxls’s <code class="docutils literal notranslate"><span class="pre">BlockRowSparseMatrix</span></code> representation, which is designed to be GPU-friendly</p></li>
<li><p>Linear solvers and preconditioning strategies</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="n">logger</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;level&gt;</span><span class="si">{level: &lt;8}</span><span class="s2">&lt;/level&gt; | </span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="the-gauss-newton-approximation">
<h2>The Gauss-Newton approximation<a class="headerlink" href="#the-gauss-newton-approximation" title="Link to this heading">¶</a></h2>
<p>Newton’s method for minimizing <span class="math notranslate nohighlight">\(f(x) = \frac{1}{2}\sum_i \|r_i(x)\|^2\)</span> requires the
Hessian <span class="math notranslate nohighlight">\(\nabla^2 f\)</span>, which is expensive to compute. Gauss-Newton instead approximates
the Hessian using only first-order information:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\nabla^2 f \approx J^\top J\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(J = \partial r / \partial x\)</span> is the Jacobian of the stacked residual vector
<span class="math notranslate nohighlight">\(r(x) = [r_0(x)^\top, r_1(x)^\top, \ldots]^\top\)</span> with respect to variable tangent
vectors (for Euclidean variables, this is just <span class="math notranslate nohighlight">\(\partial r / \partial x\)</span>).</p>
</section>
<section id="why-jacobians-are-sparse">
<h2>Why Jacobians are sparse<a class="headerlink" href="#why-jacobians-are-sparse" title="Link to this heading">¶</a></h2>
<p>Residual terms in nonlinear least squares often depend on only a subset of the
optimization variables. For example, a pairwise cost between two poses only depends
on those two poses, not the hundreds of other poses in a SLAM problem. This produces
sparse Jacobians: row block <span class="math notranslate nohighlight">\(i\)</span> of <span class="math notranslate nohighlight">\(J\)</span> has non-zeros only in columns corresponding
to the variables that <span class="math notranslate nohighlight">\(r_i\)</span> depends on.</p>
<p>This sparsity pattern corresponds to the adjacency matrix of a bipartite factor graph:</p>
<ul class="simple">
<li><p><strong>Variables</strong> (circles): The parameters we’re optimizing</p></li>
<li><p><strong>Costs</strong> (squares): Residual functions that connect to their dependent variables</p></li>
</ul>
<p>Consider an optimization problem with variables <span class="math notranslate nohighlight">\(x_0\)</span>, <span class="math notranslate nohighlight">\(x_1\)</span>, <span class="math notranslate nohighlight">\(x_2\)</span> and three types
of costs: A (unary), B (binary between adjacent variables), and C (binary between
non-adjacent variables).</p>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Internal implementation.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Create a simple factor graph visualization.</span>
<span class="c1"># Variables: x0 (dim 2), x1 (dim 2), x2 (dim 2)</span>
<span class="c1"># Cost types: A (unary), B (binary adjacent), C (binary non-adjacent)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Factor Graph&quot;</span><span class="p">,</span> <span class="s2">&quot;Jacobian Sparsity Pattern&quot;</span><span class="p">),</span>
    <span class="n">column_widths</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">],</span>
    <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Factor graph layout.</span>
<span class="n">var_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">var_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">var_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x₀&quot;</span><span class="p">,</span> <span class="s2">&quot;x₁&quot;</span><span class="p">,</span> <span class="s2">&quot;x₂&quot;</span><span class="p">]</span>
<span class="n">var_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Tangent dimensions (all 2D).</span>

<span class="c1"># C₀ placed above the variables for cleaner layout.</span>
<span class="n">cost_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">cost_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">cost_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A₀&quot;</span><span class="p">,</span> <span class="s2">&quot;B₀&quot;</span><span class="p">,</span> <span class="s2">&quot;B₁&quot;</span><span class="p">,</span> <span class="s2">&quot;A₁&quot;</span><span class="p">,</span> <span class="s2">&quot;C₀&quot;</span><span class="p">]</span>
<span class="n">cost_dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># Residual dimensions (all 2).</span>
<span class="c1"># Colors: A costs (blue), B costs (orange), C costs (green).</span>
<span class="n">cost_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#1976d2&quot;</span><span class="p">,</span> <span class="s2">&quot;#f57c00&quot;</span><span class="p">,</span> <span class="s2">&quot;#f57c00&quot;</span><span class="p">,</span> <span class="s2">&quot;#1976d2&quot;</span><span class="p">,</span> <span class="s2">&quot;#388e3c&quot;</span><span class="p">]</span>

<span class="c1"># Connections: (cost_idx, var_idx).</span>
<span class="c1"># A₀→x₀, B₀→x₀,x₁, B₁→x₁,x₂, A₁→x₂, C₀→x₀,x₂</span>
<span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>

<span class="c1"># Draw edges.</span>
<span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">cost_x</span><span class="p">[</span><span class="n">ci</span><span class="p">],</span> <span class="n">var_x</span><span class="p">[</span><span class="n">vi</span><span class="p">]],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">cost_y</span><span class="p">[</span><span class="n">ci</span><span class="p">],</span> <span class="n">var_y</span><span class="p">[</span><span class="n">vi</span><span class="p">]],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#888&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Draw variables (circles).</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">var_x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">var_y</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers+text&quot;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#2196F3&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)),</span>
        <span class="n">text</span><span class="o">=</span><span class="n">var_labels</span><span class="p">,</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;middle center&quot;</span><span class="p">,</span>
        <span class="n">textfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Variables&quot;</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;%</span><span class="si">{text}</span><span class="s2">&lt;br&gt;dim=%</span><span class="si">{customdata}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
        <span class="n">customdata</span><span class="o">=</span><span class="n">var_dims</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Draw costs (squares) - color by cost type.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span><span class="n">cost_x</span><span class="p">,</span> <span class="n">cost_y</span><span class="p">,</span> <span class="n">cost_labels</span><span class="p">,</span> <span class="n">cost_colors</span><span class="p">,</span> <span class="n">cost_dims</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">cx</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">cy</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers+text&quot;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">label</span><span class="p">],</span>
            <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;middle center&quot;</span><span class="p">,</span>
            <span class="n">textfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&lt;br&gt;residual dim=</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Build Jacobian sparsity pattern.</span>
<span class="c1"># Order costs by type for the matrix: A₀, A₁, B₀, B₁, C₀</span>
<span class="n">cost_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># Reorder to group by type.</span>
<span class="n">ordered_cost_dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cost_order</span><span class="p">]</span>
<span class="n">ordered_cost_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cost_order</span><span class="p">]</span>
<span class="n">ordered_cost_colors_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># A, A, B, B, C</span>

<span class="n">n_rows</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ordered_cost_dims</span><span class="p">)</span>  <span class="c1"># 10</span>
<span class="n">n_cols</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">var_dims</span><span class="p">)</span>  <span class="c1"># 6</span>

<span class="n">row_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ordered_cost_dims</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">col_starts</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">var_dims</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Build edge map for reordered costs.</span>
<span class="c1"># Original edges: A₀→x₀, B₀→x₀,x₁, B₁→x₁,x₂, A₁→x₂, C₀→x₀,x₂</span>
<span class="c1"># Reordered: A₀→x₀, A₁→x₂, B₀→x₀,x₁, B₁→x₁,x₂, C₀→x₀,x₂</span>
<span class="n">reordered_edges</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span>  <span class="c1"># A₀ → x₀</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]),</span>  <span class="c1"># A₁ → x₂</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>  <span class="c1"># B₀ → x₀, x₁</span>
    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>  <span class="c1"># B₁ → x₁, x₂</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>  <span class="c1"># C₀ → x₀, x₂ (non-adjacent!)</span>
<span class="p">]</span>

<span class="c1"># Create color matrix for heatmap.</span>
<span class="n">color_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">))</span>
<span class="n">color_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># A=1 (blue), B=2 (orange), C=3 (green)</span>
<span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">var_indices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reordered_edges</span><span class="p">):</span>
    <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">row_starts</span><span class="p">[</span><span class="n">row_idx</span><span class="p">],</span> <span class="n">row_starts</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">ordered_cost_dims</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">var_indices</span><span class="p">:</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">col_starts</span><span class="p">[</span><span class="n">vi</span><span class="p">],</span> <span class="n">col_starts</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span> <span class="o">+</span> <span class="n">var_dims</span><span class="p">[</span><span class="n">vi</span><span class="p">]</span>
        <span class="n">color_matrix</span><span class="p">[</span><span class="n">r0</span><span class="p">:</span><span class="n">r1</span><span class="p">,</span> <span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_vals</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span>

<span class="c1"># Custom colorscale: white, blue, orange, green.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
    <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
        <span class="n">z</span><span class="o">=</span><span class="n">color_matrix</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.33</span><span class="p">,</span> <span class="s2">&quot;#1976d2&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.67</span><span class="p">,</span> <span class="s2">&quot;#f57c00&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;#388e3c&quot;</span><span class="p">]],</span>
        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">zmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;row %</span><span class="si">{y}</span><span class="s2">, col %</span><span class="si">{x}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Add grid lines for Jacobian.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">n_cols</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ddd&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ddd&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Add block separators (between cost types).</span>
<span class="n">type_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="c1"># After A costs, after B costs</span>
<span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">type_boundaries</span><span class="p">:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">n_cols</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=</span><span class="n">n_rows</span> <span class="o">-</span> <span class="n">rs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">n_rows</span> <span class="o">-</span> <span class="n">rs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#999&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">col_starts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">cs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">cs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y0</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">y1</span><span class="o">=</span><span class="n">n_rows</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;#2196F3&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Add column labels (variables) at bottom.</span>
<span class="n">col_centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">var_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">var_dims</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">col_centers</span><span class="p">,</span> <span class="n">var_labels</span><span class="p">)):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">cx</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span>
        <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span>
        <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Add row labels (costs) at left - show type groups.</span>
<span class="n">type_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span>
<span class="n">type_row_ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">type_labels</span><span class="p">,</span> <span class="n">type_row_ranges</span><span class="p">):</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">n_rows</span> <span class="o">-</span> <span class="p">(</span><span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">ry</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
        <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span>
        <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">HTML</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_plotlyjs</span><span class="o">=</span><span class="s2">&quot;cdn&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>                        <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.3.0.min.js" integrity="sha256-bO3dS6yCpk9aK4gUpNELtCiDeSYvGYnK7jFI58NQnHI=" crossorigin="anonymous"></script>                <div id="0fface0d-9583-4828-9740-d65097dee578" class="plotly-graph-div" style="height:350px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("0fface0d-9583-4828-9740-d65097dee578")) {                    Plotly.newPlot(                        "0fface0d-9583-4828-9740-d65097dee578",                        [{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[0,0],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[1,0],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[1,2],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[3,2],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[3,4],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[4,4],"y":[0,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[2,0],"y":[2,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hoverinfo":"skip","line":{"color":"#888","width":2},"mode":"lines","showlegend":false,"x":[2,4],"y":[2,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"customdata":[2,2,2],"hovertemplate":"%{text}\u003cbr\u003edim=%{customdata}\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#2196F3","line":{"color":"white","width":2},"size":40},"mode":"markers+text","name":"Variables","text":["x\u2080","x\u2081","x\u2082"],"textfont":{"color":"white","size":14},"textposition":"middle center","x":[0,2,4],"y":[1,1,1],"type":"scatter","xaxis":"x","yaxis":"y"},{"hovertemplate":"A\u2080\u003cbr\u003eresidual dim=2\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#1976d2","line":{"color":"white","width":2},"size":35,"symbol":"square"},"mode":"markers+text","name":"A\u2080","showlegend":false,"text":["A\u2080"],"textfont":{"color":"white","size":12},"textposition":"middle center","x":[0],"y":[0],"type":"scatter","xaxis":"x","yaxis":"y"},{"hovertemplate":"B\u2080\u003cbr\u003eresidual dim=2\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#f57c00","line":{"color":"white","width":2},"size":35,"symbol":"square"},"mode":"markers+text","name":"B\u2080","showlegend":false,"text":["B\u2080"],"textfont":{"color":"white","size":12},"textposition":"middle center","x":[1],"y":[0],"type":"scatter","xaxis":"x","yaxis":"y"},{"hovertemplate":"B\u2081\u003cbr\u003eresidual dim=2\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#f57c00","line":{"color":"white","width":2},"size":35,"symbol":"square"},"mode":"markers+text","name":"B\u2081","showlegend":false,"text":["B\u2081"],"textfont":{"color":"white","size":12},"textposition":"middle center","x":[3],"y":[0],"type":"scatter","xaxis":"x","yaxis":"y"},{"hovertemplate":"A\u2081\u003cbr\u003eresidual dim=2\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#1976d2","line":{"color":"white","width":2},"size":35,"symbol":"square"},"mode":"markers+text","name":"A\u2081","showlegend":false,"text":["A\u2081"],"textfont":{"color":"white","size":12},"textposition":"middle center","x":[4],"y":[0],"type":"scatter","xaxis":"x","yaxis":"y"},{"hovertemplate":"C\u2080\u003cbr\u003eresidual dim=2\u003cextra\u003e\u003c\u002fextra\u003e","marker":{"color":"#388e3c","line":{"color":"white","width":2},"size":35,"symbol":"square"},"mode":"markers+text","name":"C\u2080","showlegend":false,"text":["C\u2080"],"textfont":{"color":"white","size":12},"textposition":"middle center","x":[2],"y":[2],"type":"scatter","xaxis":"x","yaxis":"y"},{"colorscale":[[0,"white"],[0.33,"#1976d2"],[0.67,"#f57c00"],[1,"#388e3c"]],"hovertemplate":"row %{y}, col %{x}\u003cextra\u003e\u003c\u002fextra\u003e","showscale":false,"z":{"dtype":"f8","bdata":"AAAAAAAACEAAAAAAAAAIQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIQAAAAAAAAAhAAAAAAAAACEAAAAAAAAAIQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIQAAAAAAAAAhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwPwAAAAAAAPA\u002fAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwPwAAAAAAAPA\u002fAAAAAAAA8D8AAAAAAADwPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8D8AAAAAAADwPwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA","shape":"10, 6"},"zmax":3,"zmin":0,"type":"heatmap","xaxis":"x2","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"}}},"xaxis":{"anchor":"y","domain":[0.0,0.396],"showgrid":false,"zeroline":false,"showticklabels":false},"yaxis":{"anchor":"x","domain":[0.0,1.0],"showgrid":false,"zeroline":false,"showticklabels":false},"xaxis2":{"anchor":"y2","domain":[0.516,1.0],"showgrid":false,"zeroline":false,"showticklabels":false},"yaxis2":{"anchor":"x2","domain":[0.0,1.0],"showgrid":false,"zeroline":false,"showticklabels":false},"annotations":[{"font":{"size":16},"showarrow":false,"text":"Factor Graph","x":0.198,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":16},"showarrow":false,"text":"Jacobian Sparsity Pattern","x":0.758,"xanchor":"center","xref":"paper","y":1.0,"yanchor":"bottom","yref":"paper"},{"font":{"size":14},"showarrow":false,"text":"x\u2080","x":0.5,"xref":"x2","y":-1.0,"yref":"y2"},{"font":{"size":14},"showarrow":false,"text":"x\u2081","x":2.5,"xref":"x2","y":-1.0,"yref":"y2"},{"font":{"size":14},"showarrow":false,"text":"x\u2082","x":4.5,"xref":"x2","y":-1.0,"yref":"y2"},{"font":{"size":12},"showarrow":false,"text":"A","x":-0.8,"xref":"x2","y":7.5,"yref":"y2"},{"font":{"size":12},"showarrow":false,"text":"B","x":-0.8,"xref":"x2","y":3.5,"yref":"y2"},{"font":{"size":12},"showarrow":false,"text":"C","x":-0.8,"xref":"x2","y":0.5,"yref":"y2"}],"shapes":[{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":-0.5,"y1":-0.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":0.5,"y1":0.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":1.5,"y1":1.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":2.5,"y1":2.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":3.5,"y1":3.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":4.5,"y1":4.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":5.5,"y1":5.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":6.5,"y1":6.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":7.5,"y1":7.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":8.5,"y1":8.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":9.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":-0.5,"x1":-0.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":0.5,"x1":0.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":1.5,"x1":1.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":2.5,"x1":2.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":3.5,"x1":3.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":4.5,"x1":4.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#ddd","width":1},"type":"line","x0":5.5,"x1":5.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#999","width":2},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":5.5,"y1":5.5,"yref":"y2"},{"line":{"color":"#999","width":2},"type":"line","x0":-0.5,"x1":5.5,"xref":"x2","y0":1.5,"y1":1.5,"yref":"y2"},{"line":{"color":"#2196F3","width":2},"type":"line","x0":1.5,"x1":1.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"},{"line":{"color":"#2196F3","width":2},"type":"line","x0":3.5,"x1":3.5,"xref":"x2","y0":-0.5,"y1":9.5,"yref":"y2"}],"margin":{"t":40,"b":60,"l":60,"r":40},"height":350,"showlegend":false},                        {"responsive": true}                    )                };            </script>        </div></div></div>
</div>
<p>In this example, the Jacobian is ~60% zeros, and this ratio grows with problem size.
For large SLAM or bundle adjustment problems, Jacobians can be &gt;99% sparse. Exploiting
this sparsity is critical for scaling to large problems.</p>
</section>
<section id="sparse-matrix-formats">
<h2>Sparse matrix formats<a class="headerlink" href="#sparse-matrix-formats" title="Link to this heading">¶</a></h2>
<p>jaxls implements three sparse matrix representations. You can select between them
using the <code class="docutils literal notranslate"><span class="pre">sparse_mode</span></code> parameter:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default: block-row format (best for CG on GPU).</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">sparse_mode</span><span class="o">=</span><span class="s2">&quot;blockrow&quot;</span><span class="p">)</span>

<span class="c1"># COO format (converts to JAX BCOO).</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">sparse_mode</span><span class="o">=</span><span class="s2">&quot;coo&quot;</span><span class="p">)</span>

<span class="c1"># CSR format (always used for CHOLMOD).</span>
<span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">sparse_mode</span><span class="o">=</span><span class="s2">&quot;csr&quot;</span><span class="p">)</span>
</pre></div>
</div>
<section id="blockrowsparsematrix">
<h3>BlockRowSparseMatrix<a class="headerlink" href="#blockrowsparsematrix" title="Link to this heading">¶</a></h3>
<p>jaxls’s default and recommended sparse matrix representation uses what we call
sparse “block-rows”. Costs of the same type have Jacobians with identical structure:
same block sizes, just different values and column positions. jaxls exploits this by
batching block-rows from the same cost type.</p>
<p>Using the same example from above:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}
J = \left[\begin{array}{cc|cc|cc}
\color{#1976d2}{0.8} &amp; \color{#1976d2}{0.3} &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\color{#1976d2}{0.1} &amp; \color{#1976d2}{0.9} &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \color{#1976d2}{0.6} &amp; \color{#1976d2}{0.2} \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; \color{#1976d2}{0.4} &amp; \color{#1976d2}{0.7} \\
\hline
\color{#f57c00}{1.2} &amp; \color{#f57c00}{0.4} &amp; \color{#f57c00}{0.7} &amp; \color{#f57c00}{0.2} &amp; 0 &amp; 0 \\
\color{#f57c00}{0.5} &amp; \color{#f57c00}{0.6} &amp; \color{#f57c00}{0.3} &amp; \color{#f57c00}{0.8} &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \color{#f57c00}{0.9} &amp; \color{#f57c00}{0.1} &amp; \color{#f57c00}{0.4} &amp; \color{#f57c00}{0.7} \\
0 &amp; 0 &amp; \color{#f57c00}{0.2} &amp; \color{#f57c00}{0.5} &amp; \color{#f57c00}{0.8} &amp; \color{#f57c00}{0.3} \\
\hline
\color{#388e3c}{0.3} &amp; \color{#388e3c}{0.9} &amp; 0 &amp; 0 &amp; \color{#388e3c}{0.5} &amp; \color{#388e3c}{0.1} \\
\color{#388e3c}{0.7} &amp; \color{#388e3c}{0.4} &amp; 0 &amp; 0 &amp; \color{#388e3c}{0.2} &amp; \color{#388e3c}{0.8}
\end{array}\right]
\begin{array}{l}
\leftarrow A_0 \\
\\
\leftarrow A_1 \\
\\
\leftarrow B_0 \\
\\
\leftarrow B_1 \\
\\
\leftarrow C_0 \\
\end{array}
\end{split}\]</div>
</div>
<p>Each cost type becomes one <code class="docutils literal notranslate"><span class="pre">SparseBlockRow</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jdc</span><span class="o">.</span><span class="n">pytree_dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BlockRowSparseMatrix</span><span class="p">:</span>
    <span class="n">block_rows</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SparseBlockRow</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># One per cost type.</span>

<span class="nd">@jdc</span><span class="o">.</span><span class="n">pytree_dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SparseBlockRow</span><span class="p">:</span>
    <span class="n">num_cols</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">Static</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>                      <span class="c1"># Total matrix width.</span>
    <span class="n">block_num_cols</span><span class="p">:</span> <span class="n">jdc</span><span class="o">.</span><span class="n">Static</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>    <span class="c1"># Block widths.</span>
    <span class="n">start_cols</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>              <span class="c1"># Column positions (traced).</span>
    <span class="n">blocks_concat</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>                       <span class="c1"># Jacobian values (traced).</span>
</pre></div>
</div>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Cost type</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">blocks_concat</span></code> shape</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">block_num_cols</span></code></p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">start_cols</span></code></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2,</span> <span class="pre">2)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(2,)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[[0],</span> <span class="pre">[4]]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>B</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2,</span> <span class="pre">4)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[[0,</span> <span class="pre">2],</span> <span class="pre">[2,</span> <span class="pre">4]]</span></code></p></td>
</tr>
<tr class="row-even"><td><p>C</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2,</span> <span class="pre">4)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[[0,</span> <span class="pre">4]]</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p>The zeros are never stored. <code class="docutils literal notranslate"><span class="pre">start_cols</span></code> records where each block lands in the full matrix.</p>
<p>The block-row format is more GPU-friendly than traditional sparse formats like COO
and CSR, which store arbitrary (row, col, value) entries. This leads to irregular
memory access patterns and poor cache utilization on GPUs, where performance depends
on coalesced memory access and high arithmetic intensity. The block-row format
sidesteps these issues:</p>
<ul class="simple">
<li><p><strong>Dense matmul kernels.</strong> Jacobian blocks from each cost type are stacked into
dense arrays (<code class="docutils literal notranslate"><span class="pre">blocks_concat</span></code>). Matrix-vector products become batched dense
matmuls, which map directly to optimized GPU kernels (cuBLAS, etc.).</p></li>
<li><p><strong>Structured indexing.</strong> While <code class="docutils literal notranslate"><span class="pre">start_cols</span></code> involves dynamic indexing for
gather/scatter operations, the block structure (number of blocks, their sizes)
is static. This is more regular than arbitrary element-wise sparse indexing.</p></li>
<li><p><strong>Efficient preconditioning.</strong> Diagonal blocks of <span class="math notranslate nohighlight">\(J^T J\)</span> can be accumulated
without materializing the full matrix, enabling Block-Jacobi preconditioning
with minimal overhead.</p></li>
</ul>
</section>
<section id="sparsecoomatrix-and-sparsecsrmatrix">
<h3>SparseCooMatrix and SparseCsrMatrix<a class="headerlink" href="#sparsecoomatrix-and-sparsecsrmatrix" title="Link to this heading">¶</a></h3>
<p>jaxls also supports standard sparse formats for testing, benchmarking, and
interoperability.</p>
<p><strong>SparseCooMatrix</strong> (coordinate format, convertible to JAX’s native <code class="docutils literal notranslate"><span class="pre">BCOO</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jdc</span><span class="o">.</span><span class="n">pytree_dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SparseCooMatrix</span><span class="p">:</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>              <span class="c1"># Shape: (nnz,).</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">SparseCooCoordinates</span>   <span class="c1"># Row and column indices.</span>
</pre></div>
</div>
<p><strong>SparseCsrMatrix</strong> (compressed sparse row, convertible to JAX’s native <code class="docutils literal notranslate"><span class="pre">BCSR</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jdc</span><span class="o">.</span><span class="n">pytree_dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SparseCsrMatrix</span><span class="p">:</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>              <span class="c1"># Shape: (nnz,).</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">SparseCsrCoordinates</span>   <span class="c1"># indices and indptr arrays.</span>
</pre></div>
</div>
</section>
</section>
<section id="linear-solvers">
<h2>Linear solvers<a class="headerlink" href="#linear-solvers" title="Link to this heading">¶</a></h2>
<p>The Gauss-Newton update requires solving <span class="math notranslate nohighlight">\((J^T J + \lambda I) \Delta x = -J^T r\)</span>.
jaxls offers three linear solvers for this system:</p>
<section id="conjugate-gradient-default">
<h3>Conjugate gradient (default)<a class="headerlink" href="#conjugate-gradient-default" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;conjugate_gradient&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is the default and generally recommended solver.</p>
<ul class="simple">
<li><p><strong>Best for</strong>: Large sparse problems, GPU acceleration</p></li>
<li><p><strong>Pros</strong>: Memory-efficient (never forms <span class="math notranslate nohighlight">\(J^T J\)</span>), JAX-native, works on GPU</p></li>
<li><p><strong>Cons</strong>: May require many iterations, sensitive to conditioning</p></li>
</ul>
<p>Uses inexact Newton via <a class="reference external" href="https://doi.org/10.1137/0917003">Eisenstat-Walker</a> adaptive tolerances.</p>
</section>
<section id="dense-cholesky">
<h3>Dense Cholesky<a class="headerlink" href="#dense-cholesky" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;dense_cholesky&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Best for</strong>: Small problems (&lt;1000 variables)</p></li>
<li><p><strong>Pros</strong>: Direct solve, no iterations, numerically stable</p></li>
<li><p><strong>Cons</strong>: Forms dense <span class="math notranslate nohighlight">\(J^T J\)</span> matrix, <span class="math notranslate nohighlight">\(O(n^3)\)</span> complexity</p></li>
</ul>
</section>
<section id="sparse-cholesky-cholmod">
<h3>Sparse Cholesky (CHOLMOD)<a class="headerlink" href="#sparse-cholesky-cholmod" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;cholmod&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>Best for</strong>: Large sparse problems on CPU</p></li>
<li><p><strong>Pros</strong>: Direct solve, exploits sparsity, sparse fill-reducing ordering</p></li>
<li><p><strong>Cons</strong>: CPU only, requires SuiteSparse installation</p></li>
</ul>
<p>jaxls caches the symbolic factorization (sparsity pattern analysis), so repeated
solves with the same structure are fast.</p>
</section>
</section>
<section id="preconditioning">
<h2>Preconditioning<a class="headerlink" href="#preconditioning" title="Link to this heading">¶</a></h2>
<p>For conjugate gradient, preconditioning accelerates convergence by transforming
the linear system. Instead of solving <span class="math notranslate nohighlight">\(Ax = b\)</span> directly, we solve
<span class="math notranslate nohighlight">\(M^{-1}Ax = M^{-1}b\)</span> where the preconditioner <span class="math notranslate nohighlight">\(M \approx A\)</span> is easy to invert.</p>
<p>For the normal equations <span class="math notranslate nohighlight">\(A = J^T J\)</span>, jaxls provides two preconditioners:</p>
<section id="block-jacobi-default">
<h3>Block Jacobi (default)<a class="headerlink" href="#block-jacobi-default" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;conjugate_gradient&quot;</span><span class="p">,</span>
    <span class="n">conjugate_gradient</span><span class="o">=</span><span class="n">jaxls</span><span class="o">.</span><span class="n">ConjugateGradientConfig</span><span class="p">(</span>
        <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;block_jacobi&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Uses <span class="math notranslate nohighlight">\(M = \text{blockdiag}(J^T J)\)</span>, where blocks correspond to individual variables.
For variable <span class="math notranslate nohighlight">\(i\)</span> with Jacobian columns <span class="math notranslate nohighlight">\(J_i\)</span>:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[M_i = J_i^T J_i\]</div>
</div>
<p>Effective when variables of the same type have similar scales.</p>
</section>
<section id="point-jacobi">
<h3>Point Jacobi<a class="headerlink" href="#point-jacobi" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
    <span class="n">linear_solver</span><span class="o">=</span><span class="s2">&quot;conjugate_gradient&quot;</span><span class="p">,</span>
    <span class="n">conjugate_gradient</span><span class="o">=</span><span class="n">jaxls</span><span class="o">.</span><span class="n">ConjugateGradientConfig</span><span class="p">(</span>
        <span class="n">preconditioner</span><span class="o">=</span><span class="s2">&quot;point_jacobi&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Uses <span class="math notranslate nohighlight">\(M = \text{diag}(J^T J)\)</span>, a scalar per tangent dimension:</p>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[M_{ii} = \sum_j J_{ji}^2\]</div>
</div>
<p>Cheaper to compute but less effective than block Jacobi.</p>
</section>
</section>
<section id="related-pages">
<h2>Related pages<a class="headerlink" href="#related-pages" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../../guide/tips_and_gotchas/"><span class="doc">Tips and gotchas</span></a>: Practical guidance on solver and Jacobian mode selection</p></li>
<li><p><a class="reference internal" href="../../guide/advanced/custom_jacobians/"><span class="doc">Custom Jacobians</span></a>: Providing analytical Jacobians</p></li>
<li><p><a class="reference internal" href="../traced_vs_static/"><span class="doc">What’s traced?</span></a>: What values are traced vs static in JAX compilation</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../traced_vs_static/">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">What’s traced?</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../typed_api/">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Typed API</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/brentyi/jaxls" aria-label="GitHub">
            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Sparse matrices</a><ul>
<li><a class="reference internal" href="#the-gauss-newton-approximation">The Gauss-Newton approximation</a></li>
<li><a class="reference internal" href="#why-jacobians-are-sparse">Why Jacobians are sparse</a></li>
<li><a class="reference internal" href="#sparse-matrix-formats">Sparse matrix formats</a><ul>
<li><a class="reference internal" href="#blockrowsparsematrix">BlockRowSparseMatrix</a></li>
<li><a class="reference internal" href="#sparsecoomatrix-and-sparsecsrmatrix">SparseCooMatrix and SparseCsrMatrix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#linear-solvers">Linear solvers</a><ul>
<li><a class="reference internal" href="#conjugate-gradient-default">Conjugate gradient (default)</a></li>
<li><a class="reference internal" href="#dense-cholesky">Dense Cholesky</a></li>
<li><a class="reference internal" href="#sparse-cholesky-cholmod">Sparse Cholesky (CHOLMOD)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#preconditioning">Preconditioning</a><ul>
<li><a class="reference internal" href="#block-jacobi-default">Block Jacobi (default)</a></li>
<li><a class="reference internal" href="#point-jacobi">Point Jacobi</a></li>
</ul>
</li>
<li><a class="reference internal" href="#related-pages">Related pages</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=fd10adb8"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>