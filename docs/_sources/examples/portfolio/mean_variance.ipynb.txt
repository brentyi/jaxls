{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "cell-0",
   "metadata": {},
   "source": "# Mean-variance allocation\n\nIn this notebook, we solve a mean-variance portfolio optimization problem: finding\nasset allocations that maximize return for a given level of risk, following the\n[Markowitz framework](https://en.wikipedia.org/wiki/Modern_portfolio_theory).\n\nThis example is adapted from the [JuMP portfolio optimization tutorial](https://jump.dev/JuMP.jl/stable/tutorials/nonlinear/portfolio/).\n\nFeatures used:\n- {class}`~jaxls.Var` with vector-valued default\n- Equality constraints (`constraint_eq_zero`): budget constraint\n- Inequality constraints (`constraint_geq_zero`): minimum return, no short-selling\n- Augmented Lagrangian solver for constrained optimization\n- Efficient frontier via parametric sweeps"
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "cell-1",
   "metadata": {
    "tags": [
     "hide-cell",
     "hide-input"
    ]
   },
   "outputs": [],
   "source": [
    "import sys\n",
    "from loguru import logger\n",
    "\n",
    "logger.remove()\n",
    "logger.add(sys.stdout, format=\"<level>{level: <8}</level> | {message}\");"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "cell-2",
   "metadata": {},
   "outputs": [],
   "source": [
    "import jax\n",
    "import jax.numpy as jnp\n",
    "import jaxls"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cell-3",
   "metadata": {},
   "source": [
    "## Historical stock data\n",
    "\n",
    "Monthly stock prices from November 2000 to November 2001 for three stocks:\n",
    "IBM, Walmart (WMT), and Southern Electric (SEHI)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "cell-4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Price data shape: (13, 3) (months × stocks)\n"
     ]
    }
   ],
   "source": [
    "stock_names = [\"IBM\", \"WMT\", \"SEHI\"]\n",
    "\n",
    "# Monthly prices (13 months: Nov 2000 - Nov 2001)\n",
    "prices = jnp.array(\n",
    "    [\n",
    "        [93.043, 51.826, 1.063],\n",
    "        [84.585, 52.823, 0.938],\n",
    "        [111.453, 56.477, 1.0],\n",
    "        [99.525, 49.805, 0.938],\n",
    "        [95.819, 50.287, 1.438],\n",
    "        [114.708, 51.521, 1.7],\n",
    "        [111.515, 51.531, 2.54],\n",
    "        [113.211, 48.664, 2.39],\n",
    "        [104.942, 55.744, 3.12],\n",
    "        [99.827, 47.916, 2.98],\n",
    "        [91.607, 49.438, 1.9],\n",
    "        [107.937, 51.336, 1.75],\n",
    "        [115.59, 55.081, 1.8],\n",
    "    ]\n",
    ")\n",
    "\n",
    "print(f\"Price data shape: {prices.shape} (months × stocks)\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "44i17f81qkp",
   "metadata": {
    "tags": [
     "hide-input"
    ]
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>                        <script type=\"text/javascript\">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>\n",
       "        <script charset=\"utf-8\" src=\"https://cdn.plot.ly/plotly-3.1.0.min.js\" integrity=\"sha256-Ei4740bWZhaUTQuD6q9yQlgVCMPBz6CZWhevDYPv93A=\" crossorigin=\"anonymous\"></script>                <div id=\"97af2587-9e8b-44de-9d0f-77cad62a4e21\" class=\"plotly-graph-div\" style=\"height:350px; width:100%;\"></div>            <script type=\"text/javascript\">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById(\"97af2587-9e8b-44de-9d0f-77cad62a4e21\")) {                    Plotly.newPlot(                        \"97af2587-9e8b-44de-9d0f-77cad62a4e21\",                        [{\"line\":{\"color\":\"#2196F3\",\"width\":2},\"marker\":{\"size\":6},\"mode\":\"lines+markers\",\"name\":\"IBM\",\"x\":[\"Nov '00\",\"Dec '00\",\"Jan '01\",\"Feb '01\",\"Mar '01\",\"Apr '01\",\"May '01\",\"Jun '01\",\"Jul '01\",\"Aug '01\",\"Sep '01\",\"Oct '01\",\"Nov '01\"],\"y\":{\"dtype\":\"f4\",\"bdata\":\"BBa6QoUrqULw595CzQzHQlSjv0J\\u002fauVCrgffQghs4kJO4tFCbafHQsk2t0K+39dCFC7nQg==\"},\"type\":\"scatter\"},{\"line\":{\"color\":\"#4CAF50\",\"width\":2},\"marker\":{\"size\":6},\"mode\":\"lines+markers\",\"name\":\"WMT\",\"x\":[\"Nov '00\",\"Dec '00\",\"Jan '01\",\"Feb '01\",\"Mar '01\",\"Apr '01\",\"May '01\",\"Jun '01\",\"Jul '01\",\"Aug '01\",\"Sep '01\",\"Oct '01\",\"Nov '01\"],\"y\":{\"dtype\":\"f4\",\"bdata\":\"001PQsFKU0Jz6GFCUjhHQuMlSUKBFU5Cvh9OQvCnQkLb+V5C\\u002fKk\\u002fQoPARUIQWE1C8lJcQg==\"},\"type\":\"scatter\"},{\"line\":{\"color\":\"#FF9800\",\"width\":2},\"marker\":{\"size\":6},\"mode\":\"lines+markers\",\"name\":\"SEHI\",\"x\":[\"Nov '00\",\"Dec '00\",\"Jan '01\",\"Feb '01\",\"Mar '01\",\"Apr '01\",\"May '01\",\"Jun '01\",\"Jul '01\",\"Aug '01\",\"Sep '01\",\"Oct '01\",\"Nov '01\"],\"y\":{\"dtype\":\"f4\",\"bdata\":\"YhCIP8UgcD8AAIA\\u002fxSBwP2IQuD+amdk\\u002fXI8iQMP1GEAUrkdAUrg+QDMz8z8AAOA\\u002fZmbmPw==\"},\"type\":\"scatter\"}],                        {\"template\":{\"data\":{\"histogram2dcontour\":[{\"type\":\"histogram2dcontour\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]}],\"choropleth\":[{\"type\":\"choropleth\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}],\"histogram2d\":[{\"type\":\"histogram2d\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]}],\"heatmap\":[{\"type\":\"heatmap\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]}],\"contourcarpet\":[{\"type\":\"contourcarpet\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}],\"contour\":[{\"type\":\"contour\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]}],\"surface\":[{\"type\":\"surface\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]}],\"mesh3d\":[{\"type\":\"mesh3d\",\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}],\"scatter\":[{\"fillpattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2},\"type\":\"scatter\"}],\"parcoords\":[{\"type\":\"parcoords\",\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scatterpolargl\":[{\"type\":\"scatterpolargl\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"bar\":[{\"error_x\":{\"color\":\"#2a3f5f\"},\"error_y\":{\"color\":\"#2a3f5f\"},\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"scattergeo\":[{\"type\":\"scattergeo\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scatterpolar\":[{\"type\":\"scatterpolar\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"scattergl\":[{\"type\":\"scattergl\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scatter3d\":[{\"type\":\"scatter3d\",\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scattermap\":[{\"type\":\"scattermap\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scattermapbox\":[{\"type\":\"scattermapbox\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scatterternary\":[{\"type\":\"scatterternary\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"scattercarpet\":[{\"type\":\"scattercarpet\",\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}}}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"baxis\":{\"endlinecolor\":\"#2a3f5f\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"minorgridcolor\":\"white\",\"startlinecolor\":\"#2a3f5f\"},\"type\":\"carpet\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#EBF0F8\"},\"line\":{\"color\":\"white\"}},\"header\":{\"fill\":{\"color\":\"#C8D4E3\"},\"line\":{\"color\":\"white\"}},\"type\":\"table\"}],\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"#E5ECF6\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}]},\"layout\":{\"autotypenumbers\":\"strict\",\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#2a3f5f\"},\"hovermode\":\"closest\",\"hoverlabel\":{\"align\":\"left\"},\"paper_bgcolor\":\"white\",\"plot_bgcolor\":\"#E5ECF6\",\"polar\":{\"bgcolor\":\"#E5ECF6\",\"angularaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"radialaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"ternary\":{\"bgcolor\":\"#E5ECF6\",\"aaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"},\"caxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\"}},\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]]},\"xaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"automargin\":true,\"zerolinewidth\":2},\"yaxis\":{\"gridcolor\":\"white\",\"linecolor\":\"white\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"white\",\"automargin\":true,\"zerolinewidth\":2},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\",\"gridwidth\":2},\"yaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\",\"gridwidth\":2},\"zaxis\":{\"backgroundcolor\":\"#E5ECF6\",\"gridcolor\":\"white\",\"linecolor\":\"white\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"white\",\"gridwidth\":2}},\"shapedefaults\":{\"line\":{\"color\":\"#2a3f5f\"}},\"annotationdefaults\":{\"arrowcolor\":\"#2a3f5f\",\"arrowhead\":0,\"arrowwidth\":1},\"geo\":{\"bgcolor\":\"white\",\"landcolor\":\"#E5ECF6\",\"subunitcolor\":\"white\",\"showland\":true,\"showlakes\":true,\"lakecolor\":\"white\"},\"title\":{\"x\":0.05},\"mapbox\":{\"style\":\"light\"}}},\"margin\":{\"t\":40,\"b\":40,\"l\":60,\"r\":40},\"legend\":{\"orientation\":\"h\",\"yanchor\":\"bottom\",\"y\":1.02,\"xanchor\":\"center\",\"x\":0.5},\"title\":{\"text\":\"Historical Stock Prices\"},\"xaxis\":{\"title\":{\"text\":\"Month\"}},\"yaxis\":{\"title\":{\"text\":\"Price ($)\"}},\"height\":350,\"hovermode\":\"x unified\"},                        {\"responsive\": true}                    )                };            </script>        </div>"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import plotly.graph_objects as go\n",
    "from IPython.display import HTML\n",
    "\n",
    "# Create date range for x-axis (Nov 2000 - Nov 2001)\n",
    "months = [\n",
    "    \"Nov '00\",\n",
    "    \"Dec '00\",\n",
    "    \"Jan '01\",\n",
    "    \"Feb '01\",\n",
    "    \"Mar '01\",\n",
    "    \"Apr '01\",\n",
    "    \"May '01\",\n",
    "    \"Jun '01\",\n",
    "    \"Jul '01\",\n",
    "    \"Aug '01\",\n",
    "    \"Sep '01\",\n",
    "    \"Oct '01\",\n",
    "    \"Nov '01\",\n",
    "]\n",
    "\n",
    "colors = [\"#2196F3\", \"#4CAF50\", \"#FF9800\"]\n",
    "\n",
    "fig = go.Figure()\n",
    "for i, (name, color) in enumerate(zip(stock_names, colors)):\n",
    "    fig.add_trace(\n",
    "        go.Scatter(\n",
    "            x=months,\n",
    "            y=prices[:, i],\n",
    "            mode=\"lines+markers\",\n",
    "            name=name,\n",
    "            line=dict(color=color, width=2),\n",
    "            marker=dict(size=6),\n",
    "        )\n",
    "    )\n",
    "\n",
    "fig.update_layout(\n",
    "    title=\"Historical Stock Prices\",\n",
    "    xaxis_title=\"Month\",\n",
    "    yaxis_title=\"Price ($)\",\n",
    "    height=350,\n",
    "    margin=dict(t=40, b=40, l=60, r=40),\n",
    "    legend=dict(orientation=\"h\", yanchor=\"bottom\", y=1.02, xanchor=\"center\", x=0.5),\n",
    "    hovermode=\"x unified\",\n",
    ")\n",
    "HTML(fig.to_html(full_html=False, include_plotlyjs=\"cdn\"))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cell-5",
   "metadata": {},
   "source": [
    "## Computing returns and covariance\n",
    "\n",
    "Monthly returns are computed as percentage changes, then we estimate\n",
    "expected returns and the covariance matrix."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "cell-6",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Expected monthly returns:\n",
      "  IBM: +2.60%\n",
      "  WMT: +0.81%\n",
      "  SEHI: +7.37%\n",
      "\n",
      "Covariance matrix:\n",
      "[[0.01864104 0.00359853 0.00130976]\n",
      " [0.00359853 0.00643694 0.00488726]\n",
      " [0.00130976 0.00488726 0.06868275]]\n"
     ]
    }
   ],
   "source": [
    "# Monthly returns: (P[t+1] - P[t]) / P[t]\n",
    "returns = jnp.diff(prices, axis=0) / prices[:-1]\n",
    "\n",
    "# Expected return (mean of monthly returns)\n",
    "expected_returns = jnp.mean(returns, axis=0)\n",
    "\n",
    "# Covariance matrix (sample covariance)\n",
    "returns_centered = returns - expected_returns\n",
    "covariance = (returns_centered.T @ returns_centered) / (returns.shape[0] - 1)\n",
    "\n",
    "print(\"Expected monthly returns:\")\n",
    "for name, r in zip(stock_names, expected_returns):\n",
    "    print(f\"  {name}: {float(r) * 100:+.2f}%\")\n",
    "print(f\"\\nCovariance matrix:\\n{covariance}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cell-7",
   "metadata": {},
   "source": [
    "## Problem formulation\n",
    "\n",
    "We want to invest $1000 to minimize portfolio variance while achieving a\n",
    "target return.\n",
    "\n",
    "Constraints:\n",
    "- Budget: total investment = $1000 (weights sum to 1)\n",
    "- Minimum return: expected return $\\geq$ target\n",
    "- No short-selling: all investments $\\geq$ 0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "cell-8",
   "metadata": {},
   "outputs": [],
   "source": [
    "class WeightsVar(jaxls.Var[jax.Array], default_factory=lambda: jnp.ones(3) / 3):\n",
    "    \"\"\"Portfolio weights (3D vector).\"\"\"\n",
    "\n",
    "\n",
    "weights_var = WeightsVar(id=0)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "cell-9",
   "metadata": {},
   "outputs": [],
   "source": [
    "@jaxls.Cost.factory\n",
    "def variance_cost(\n",
    "    vals: jaxls.VarValues, var: WeightsVar, cov_chol: jax.Array\n",
    ") -> jax.Array:\n",
    "    \"\"\"Minimize portfolio variance: ||L.T @ w||^2 = w.T @ cov @ w.\"\"\"\n",
    "    return cov_chol.T @ vals[var]\n",
    "\n",
    "\n",
    "@jaxls.Cost.factory(kind=\"constraint_eq_zero\")\n",
    "def budget_constraint(vals: jaxls.VarValues, var: WeightsVar) -> jax.Array:\n",
    "    \"\"\"Weights must sum to 1 (fully invested).\"\"\"\n",
    "    return jnp.sum(vals[var]) - 1.0\n",
    "\n",
    "\n",
    "@jaxls.Cost.factory(kind=\"constraint_geq_zero\")\n",
    "def return_constraint(\n",
    "    vals: jaxls.VarValues, var: WeightsVar, exp_ret: jax.Array, target: float\n",
    ") -> jax.Array:\n",
    "    \"\"\"Expected return must meet target: E[r] >= target.\"\"\"\n",
    "    return jnp.array([jnp.dot(vals[var], exp_ret) - target])\n",
    "\n",
    "\n",
    "@jaxls.Cost.factory(kind=\"constraint_geq_zero\")\n",
    "def no_short_constraint(vals: jaxls.VarValues, var: WeightsVar) -> jax.Array:\n",
    "    \"\"\"No short-selling: weights >= 0.\"\"\"\n",
    "    return vals[var]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cell-10",
   "metadata": {},
   "source": [
    "## Efficient frontier\n",
    "\n",
    "The efficient frontier shows the optimal trade-off between risk (variance)\n",
    "and return. We compute it by solving the optimization problem for different\n",
    "target returns.\n",
    "\n",
    "Using `jax.lax.scan`, we solve sequentially while using each solution as the\n",
    "initial guess for the next (warm-starting). This helps convergence since\n",
    "adjacent target returns have similar optimal allocations."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "cell-11",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[1mINFO    \u001b[0m | Building optimization problem with 4 terms and 1 variables: 1 costs, 1 eq_zero, 0 leq_zero, 2 geq_zero\n",
      "\u001b[1mINFO    \u001b[0m | Vectorizing group with 1 costs, 1 variables each: variance_cost\n",
      "\u001b[1mINFO    \u001b[0m | Vectorizing constraint group with 1 constraints (constraint_eq_zero), 1 variables each: augmented_budget_constraint\n",
      "\u001b[1mINFO    \u001b[0m | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 1 variables each: augmented_return_constraint\n",
      "\u001b[1mINFO    \u001b[0m | Vectorizing constraint group with 1 constraints (constraint_geq_zero), 1 variables each: augmented_no_short_constraint\n",
      "Computed 50 points on the efficient frontier\n"
     ]
    }
   ],
   "source": [
    "# Cholesky decomposition for variance cost\n",
    "cov_chol = jnp.linalg.cholesky(covariance)\n",
    "\n",
    "# Range of target returns to explore\n",
    "min_return = float(expected_returns.min())\n",
    "max_return = float(expected_returns.max())\n",
    "target_returns = jnp.linspace(min_return, max_return, 50)\n",
    "\n",
    "\n",
    "def solve_for_target(\n",
    "    current_vals: jaxls.VarValues, target: jax.Array\n",
    ") -> tuple[jaxls.VarValues, jax.Array]:\n",
    "    \"\"\"Solve portfolio optimization for a given target return.\n",
    "\n",
    "    Args:\n",
    "        current_vals: Solution from previous target (used as initial guess).\n",
    "        target: Target return for this solve.\n",
    "\n",
    "    Returns:\n",
    "        Tuple of (solution values, optimal weights).\n",
    "    \"\"\"\n",
    "    costs = [\n",
    "        variance_cost(weights_var, cov_chol),\n",
    "        budget_constraint(weights_var),\n",
    "        return_constraint(weights_var, expected_returns, target),\n",
    "        no_short_constraint(weights_var),\n",
    "    ]\n",
    "    problem = jaxls.LeastSquaresProblem(costs, [weights_var]).analyze()\n",
    "    # Use dense Cholesky solver for this small problem\n",
    "    solution = problem.solve(\n",
    "        current_vals,\n",
    "        verbose=False,\n",
    "        linear_solver=\"dense_cholesky\",\n",
    "        termination=jaxls.TerminationConfig(cost_tolerance=1e-8),\n",
    "    )\n",
    "    return solution, solution[weights_var]\n",
    "\n",
    "\n",
    "# Solve sequentially with warm-starting.\n",
    "initial_vals = jaxls.VarValues.make([weights_var])\n",
    "_, all_weights = jax.lax.scan(solve_for_target, initial_vals, target_returns)\n",
    "variances = jax.vmap(lambda w: w @ covariance @ w)(all_weights)\n",
    "returns_achieved = jax.vmap(lambda w: jnp.dot(w, expected_returns))(all_weights)\n",
    "\n",
    "print(f\"Computed {len(target_returns)} points on the efficient frontier\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cell-12",
   "metadata": {},
   "source": [
    "## Results\n",
    "\n",
    "Three views of the efficient frontier:\n",
    "1. Objective space: Standard deviation vs. expected return\n",
    "2. Risk-adjusted return: Sharpe ratio (return/risk) along the frontier\n",
    "3. Decision space: Asset allocation across the frontier"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cell-13",
   "metadata": {
    "tags": [
     "hide-input"
    ]
   },
   "outputs": [],
   "source": "import plotly.graph_objects as go\nfrom plotly.subplots import make_subplots\nfrom IPython.display import HTML\nimport math\n\n# Annualize returns and risk (monthly data -> yearly)\nannual_factor = 12\nrisk_free_rate = 0.05  # 5% annual risk-free rate.\n\n# Convert JAX arrays to Python floats for Plotly.\nstd_devs_annual = [float(jnp.sqrt(v)) * math.sqrt(annual_factor) for v in variances]\nreturns_annual = [float(r) * annual_factor for r in returns_achieved]\nsharpe_ratios = [\n    (r - risk_free_rate) / s if s > 0 else 0.0\n    for r, s in zip(returns_annual, std_devs_annual)\n]\n\ncolors = [\"#2196F3\", \"#4CAF50\", \"#FF9800\"]\n\nfig = make_subplots(\n    rows=1,\n    cols=3,\n    subplot_titles=(\"Efficient Frontier\", \"Sharpe Ratio\", \"Asset Allocation\"),\n    column_widths=[0.33, 0.33, 0.34],\n)\n\n# Scale to $1000 investment.\nstd_dev_dollars = [s * 1000 for s in std_devs_annual]\nreturn_dollars = [r * 1000 for r in returns_annual]\n# Use target returns for bar chart x-axis to avoid overlapping bars.\n# (achieved returns can be identical for low targets that fall below min-variance portfolio)\ntarget_dollars = [float(t) * annual_factor * 1000 for t in target_returns]\n\n# Left plot: Efficient frontier (std dev vs return)\nfig.add_trace(\n    go.Scatter(\n        x=std_dev_dollars,\n        y=return_dollars,\n        mode=\"lines+markers\",\n        marker=dict(size=6, color=sharpe_ratios, colorscale=\"Viridis\", showscale=False),\n        line=dict(color=\"steelblue\", width=2),\n        hovertemplate=\"Std Dev: $%{x:.0f}<br>Return: $%{y:.0f}<extra></extra>\",\n        showlegend=False,\n    ),\n    row=1,\n    col=1,\n)\n\n# Middle plot: Sharpe ratio vs return.\nfig.add_trace(\n    go.Scatter(\n        x=return_dollars,\n        y=sharpe_ratios,\n        mode=\"lines+markers\",\n        marker=dict(size=6, color=sharpe_ratios, colorscale=\"Viridis\", showscale=False),\n        line=dict(color=\"steelblue\", width=2),\n        hovertemplate=\"Return: $%{x:.0f}<br>Sharpe: %{y:.2f}<extra></extra>\",\n        showlegend=False,\n    ),\n    row=1,\n    col=2,\n)\n\n# Right plot: Asset allocation vs target return.\nfor i, (name, color) in enumerate(zip(stock_names, colors)):\n    fig.add_trace(\n        go.Bar(\n            x=target_dollars,\n            y=[float(w) * 1000 for w in all_weights[:, i]],\n            name=name,\n            marker_color=color,\n            hovertemplate=f\"{name}: $%{{y:.0f}}<extra></extra>\",\n        ),\n        row=1,\n        col=3,\n    )\n\nfig.update_xaxes(title_text=\"Std Dev ($)\", row=1, col=1)\nfig.update_yaxes(title_text=\"Return ($)\", row=1, col=1)\nfig.update_xaxes(title_text=\"Return ($)\", row=1, col=2)\nfig.update_yaxes(title_text=\"Sharpe Ratio\", row=1, col=2)\nfig.update_xaxes(title_text=\"Target Return ($)\", row=1, col=3)\nfig.update_yaxes(title_text=\"Investment ($)\", range=[0, 1050], row=1, col=3)\n\nfig.update_layout(\n    barmode=\"stack\",\n    height=400,\n    margin=dict(t=40, b=40, l=60, r=40),\n    legend=dict(orientation=\"h\", yanchor=\"bottom\", y=-0.25, xanchor=\"center\", x=0.83),\n)\nHTML(fig.to_html(full_html=False, include_plotlyjs=\"cdn\"))"
  },
  {
   "cell_type": "markdown",
   "id": "cell-14",
   "metadata": {},
   "source": [
    "The efficient frontier shows the optimal trade-off between risk (standard deviation)\n",
    "and return. SEHI has the highest expected return but also highest\n",
    "risk, while WMT provides stability. The optimal allocation shifts from WMT-heavy (low risk)\n",
    "to SEHI-heavy (high return) as we move along the frontier.\n",
    "\n",
    "For more details, see {class}`jaxls.Cost` and {class}`jaxls.LeastSquaresProblem`."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}