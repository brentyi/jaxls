<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../../genindex/"><link rel="search" title="Search" href="../../../search/"><link rel="next" title="Constraints" href="../constraints/"><link rel="prev" title="Non-Euclidean variables" href="../non_euclidean/">

    <!-- Generated with Sphinx 8.1.3 and Furo 2025.12.19 -->
        <title>Custom Jacobians - jaxls</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=6517d2d4" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-code-background: #f4f4f4;
  --color-code-foreground: #000;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../"><div class="brand">jaxls</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a
  class="sidebar-brand"
  href="../../../"
  style="margin-top: 0.75em"
>
  
  <span class="sidebar-brand-text">jaxls</span>

  
</a>

<div style="text-align: left; padding: 0 1em 1em 1em">
  <a href="https://github.com/brentyi/jaxls">
    <img src="https://img.shields.io/github/stars/brentyi/jaxls?style=social" alt="GitHub stars">
  </a>
</div><form class="sidebar-search-container" method="get" action="../../../search/" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../basics/">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips_and_gotchas/">Tips and Gotchas</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../">Advanced</a><input aria-label="Toggle navigation of Advanced" checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../non_euclidean/">Non-Euclidean variables</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Custom Jacobians</a></li>
<li class="toctree-l2"><a class="reference internal" href="../constraints/">Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../robust_costs/">Robust costs</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples/mechanics/">Mechanics</a><input aria-label="Toggle navigation of Mechanics" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/mechanics/spring_equilibrium/">Spring Equilibrium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/mechanics/cloth_simulation/">Cloth Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/mechanics/beam_bending/">Beam Bending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/mechanics/truss_analysis/">Truss Analysis</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples/vision/">Perception</a><input aria-label="Toggle navigation of Perception" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/vision/camera_calibration/">Camera calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/vision/pose_graph_2d/">SE(2) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/vision/pose_graph_3d/">SE(3) pose graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/vision/bundle_adjustment/">Bundle adjustment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/vision/imu_sensor_fusion/">IMU fusion + calibration</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples/robotics/">Robotics</a><input aria-label="Toggle navigation of Robotics" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robotics/inverse_kinematics/">Inverse Kinematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robotics/obstacle_avoidance/">Obstacle Avoidance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robotics/cart_pole_collocation/">Cart-Pole (Collocation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robotics/cart_pole_shooting/">Cart-Pole (Shooting)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/robotics/cam_design/">Cam profile optimization</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples/portfolio/">Portfolio Optimization</a><input aria-label="Toggle navigation of Portfolio Optimization" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/portfolio/mean_variance/">Mean-Variance Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/portfolio/manifold_allocation/">Manifold Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/portfolio/reparameterized_allocation/">Reparameterized Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/portfolio/cvar_optimization/">CVaR Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/portfolio/black_litterman/">Black-Litterman Allocation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/core/">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/lie_group_variables/">Lie Group Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/solver_config/">Solver Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/typed_api/">Typed API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/sparse_matrices/">Sparse matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/traced_vs_static/">What’s traced?</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../../../_sources/guide/advanced/custom_jacobians.ipynb.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="custom-jacobians">
<h1>Custom Jacobians<a class="headerlink" href="#custom-jacobians" title="Link to this heading">¶</a></h1>
<p>In nonlinear least squares, the Jacobian matrix <span class="math notranslate nohighlight">\(J\)</span> contains partial derivatives of residuals with respect to variables. It’s used to approximate the Hessian as <span class="math notranslate nohighlight">\(J^T J\)</span> for Gauss-Newton updates. By default, jaxls computes Jacobians automatically via JAX’s autodiff. This guide shows how to provide analytical Jacobians instead.</p>
<p>Features used:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api/core/#jaxls.Cost.factory" title="jaxls.Cost.factory"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;jaxls.Cost.factory</span></code></a> with <code class="docutils literal notranslate"><span class="pre">jac_custom_fn</span></code> for custom Jacobians</p></li>
<li><p><a class="reference internal" href="../../../api/core/#jaxls.Cost.factory" title="jaxls.Cost.factory"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;jaxls.Cost.factory</span></code></a> with <code class="docutils literal notranslate"><span class="pre">jac_custom_with_cache_fn</span></code> for cached intermediates</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="n">logger</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;&lt;level&gt;</span><span class="si">{level: &lt;8}</span><span class="s2">&lt;/level&gt; | </span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jaxls</span>
</pre></div>
</div>
</div>
</div>
<section id="when-to-use-custom-jacobians">
<h2>When to use custom Jacobians<a class="headerlink" href="#when-to-use-custom-jacobians" title="Link to this heading">¶</a></h2>
<p>JAX’s automatic differentiation is powerful and efficient for most use cases. However, there are situations where providing analytical Jacobians can be beneficial:</p>
<ol class="arabic simple">
<li><p><strong>Known closed-form solutions.</strong> When the Jacobian has a simple analytical form that is faster to compute than autodiff.</p></li>
<li><p><strong>Numerical stability.</strong> When the analytical form is more numerically stable than the autodiff computation.</p></li>
<li><p><strong>Reusing intermediates.</strong> When the residual computation produces intermediate values that can be reused for the Jacobian.</p></li>
</ol>
</section>
<section id="problem-setup-2d-point-fitting">
<h2>Problem setup: 2D point fitting<a class="headerlink" href="#problem-setup-2d-point-fitting" title="Link to this heading">¶</a></h2>
<p>We’ll demonstrate custom Jacobians with a simple 2D point fitting problem. Given a set of target points, we want to find the optimal location that minimizes the sum of squared distances.</p>
<p>For a point <span class="math notranslate nohighlight">\(p \in \mathbb{R}^2\)</span> and target <span class="math notranslate nohighlight">\(t_i \in \mathbb{R}^2\)</span>, the residual is the Euclidean distance:
$<span class="math notranslate nohighlight">\(r_i(p) = \|p - t_i\|\)</span>$</p>
<p>The Jacobian of the distance with respect to the point is:
$<span class="math notranslate nohighlight">\(\frac{\partial r_i}{\partial p} = \frac{(p - t_i)^T}{\|p - t_i\|}\)</span>$</p>
<p>This is a simple 1x2 row vector (residual dimension 1, tangent dimension 2).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a 2D point variable.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Point2DVar</span><span class="p">(</span><span class="n">jaxls</span><span class="o">.</span><span class="n">Var</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A 2D point variable.&quot;&quot;&quot;</span>


<span class="c1"># Generate random target points.</span>
<span class="n">num_targets</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">num_targets</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target points: </span><span class="si">{</span><span class="n">targets</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Target points: (100, 2)
</pre></div>
</div>
</div>
</div>
</section>
<section id="basic-usage-jac-custom-fn">
<h2>Basic usage: <code class="docutils literal notranslate"><span class="pre">jac_custom_fn</span></code><a class="headerlink" href="#basic-usage-jac-custom-fn" title="Link to this heading">¶</a></h2>
<p>The simplest way to provide a custom Jacobian is via the <code class="docutils literal notranslate"><span class="pre">jac_custom_fn</span></code> parameter. This function takes the same arguments as the residual function and returns a 2D Jacobian matrix.</p>
<p><strong>Important</strong>: The Jacobian shape must be <code class="docutils literal notranslate"><span class="pre">(residual_dim,</span> <span class="pre">sum_of_tangent_dims_of_variables)</span></code>. For a single <code class="docutils literal notranslate"><span class="pre">Point2DVar</span></code>, this is <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">2)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">distance_jacobian</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analytical Jacobian of distance residual.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Jacobian matrix of shape (1, 2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">target</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="c1"># Jacobian is (p - t)^T / ||p - t||, reshaped to (1, 2).</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">diff</span> <span class="o">/</span> <span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">jac_custom_fn</span><span class="o">=</span><span class="n">distance_jacobian</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">distance_cost_custom</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distance residual with custom Jacobian.&quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For comparison, here’s the same cost using autodiff:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">distance_cost_autodiff</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distance residual with autodiff Jacobian.&quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">point</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="with-cache-jac-custom-with-cache-fn">
<h2>With cache: <code class="docutils literal notranslate"><span class="pre">jac_custom_with_cache_fn</span></code><a class="headerlink" href="#with-cache-jac-custom-with-cache-fn" title="Link to this heading">¶</a></h2>
<p>When computing the residual produces intermediate values that can be reused for the Jacobian, use <code class="docutils literal notranslate"><span class="pre">jac_custom_with_cache_fn</span></code>. The residual function must return a tuple of <code class="docutils literal notranslate"><span class="pre">(residual,</span> <span class="pre">cache)</span></code>, and the Jacobian function receives this cache as its second argument.</p>
<p>In our distance example, both the residual and Jacobian need <code class="docutils literal notranslate"><span class="pre">diff</span> <span class="pre">=</span> <span class="pre">point</span> <span class="pre">-</span> <span class="pre">target</span></code> and <code class="docutils literal notranslate"><span class="pre">dist</span> <span class="pre">=</span> <span class="pre">||diff||</span></code>. We can compute these once and cache them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DistanceCache</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cache for distance computation.&quot;&quot;&quot;</span>

    <span class="n">diff</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># point - target.</span>
    <span class="n">dist</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># ||diff||.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">distance_jacobian_with_cache</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="n">DistanceCache</span><span class="p">,</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Jacobian using cached intermediate values.</span>

<span class="sd">    Args:</span>
<span class="sd">        vals: Variable values (not used since we have cache).</span>
<span class="sd">        cache: Cached diff and dist from residual computation.</span>
<span class="sd">        var: The point variable.</span>
<span class="sd">        target: Target point.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Jacobian matrix of shape (1, 2).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reuse cached values instead of recomputing.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">diff</span> <span class="o">/</span> <span class="n">cache</span><span class="o">.</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">jac_custom_with_cache_fn</span><span class="o">=</span><span class="n">distance_jacobian_with_cache</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">distance_cost_cached</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">DistanceCache</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distance residual that caches intermediates for Jacobian.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (residual, cache) - the cache is passed to the Jacobian function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">target</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">DistanceCache</span><span class="p">(</span><span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">cache</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="jacobian-shape-requirements">
<h2>Jacobian shape requirements<a class="headerlink" href="#jacobian-shape-requirements" title="Link to this heading">¶</a></h2>
<p>The Jacobian must have shape <code class="docutils literal notranslate"><span class="pre">(residual_dim,</span> <span class="pre">sum_of_tangent_dims_of_variables)</span></code>. Let’s verify our Jacobians have the correct shape:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a test point and target.</span>
<span class="n">test_var</span> <span class="o">=</span> <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_point</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>
<span class="n">test_target</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">test_vals</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="o">.</span><span class="n">make</span><span class="p">([</span><span class="n">test_var</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span><span class="n">test_point</span><span class="p">)])</span>

<span class="c1"># Check Jacobian shape from custom function.</span>
<span class="n">jac</span> <span class="o">=</span> <span class="n">distance_jacobian</span><span class="p">(</span><span class="n">test_vals</span><span class="p">,</span> <span class="n">test_var</span><span class="p">,</span> <span class="n">test_target</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Jacobian shape: </span><span class="si">{</span><span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected: (residual_dim=1, tangent_dim=2)&quot;</span><span class="p">)</span>

<span class="c1"># Verify against autodiff.</span>
<span class="n">jac_autodiff</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">test_target</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">))(</span>
    <span class="n">test_point</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Custom Jacobian:</span><span class="se">\n</span><span class="si">{</span><span class="n">jac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Autodiff Jacobian:</span><span class="se">\n</span><span class="si">{</span><span class="n">jac_autodiff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Match: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span><span class="w"> </span><span class="n">jac_autodiff</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Jacobian shape: (1, 2)
Expected: (residual_dim=1, tangent_dim=2)

Custom Jacobian:
[[0.4472136 0.8944272]]
Autodiff Jacobian:
[[0.4472136 0.8944272]]
Match: True
</pre></div>
</div>
</div>
</div>
</section>
<section id="solving-the-optimization-problem">
<h2>Solving the optimization problem<a class="headerlink" href="#solving-the-optimization-problem" title="Link to this heading">¶</a></h2>
<p>Let’s verify all three approaches produce the same result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">solve_with_cost_factory</span><span class="p">(</span><span class="n">cost_factory</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Solve the point fitting problem with a given cost factory.&quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create batched costs for all targets.</span>
    <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cost_factory</span><span class="p">(</span>
            <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_targets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span>
            <span class="n">targets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Initial guess away from the solution.</span>
    <span class="n">initial_vals</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="o">.</span><span class="n">make</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]))])</span>

    <span class="c1"># Solve.</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">LeastSquaresProblem</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">initial_vals</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: point = [</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">result_autodiff</span> <span class="o">=</span> <span class="n">solve_with_cost_factory</span><span class="p">(</span><span class="n">distance_cost_autodiff</span><span class="p">,</span> <span class="s2">&quot;Autodiff&quot;</span><span class="p">)</span>
<span class="n">result_custom</span> <span class="o">=</span> <span class="n">solve_with_cost_factory</span><span class="p">(</span><span class="n">distance_cost_custom</span><span class="p">,</span> <span class="s2">&quot;Custom &quot;</span><span class="p">)</span>
<span class="n">result_cached</span> <span class="o">=</span> <span class="n">solve_with_cost_factory</span><span class="p">(</span><span class="n">distance_cost_cached</span><span class="p">,</span> <span class="s2">&quot;Cached &quot;</span><span class="p">)</span>

<span class="c1"># The optimal point should be close to the mean of targets.</span>
<span class="c1"># (for sum of squared distances, the minimum is at the geometric median,.</span>
<span class="c1"># which is close to the mean for normally distributed points)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Target mean: [</span><span class="si">{</span><span class="n">targets</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">targets</span><span class="p">[:,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_autodiff
Autodiff: point = [0.104448, 0.063558]
<span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_custom
Custom : point = [0.104459, 0.063558]
<span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_cached
Cached : point = [0.104459, 0.063558]

Target mean: [-0.024155, 0.041008]
</pre></div>
</div>
</div>
</div>
</section>
<section id="performance-comparison">
<h2>Performance comparison<a class="headerlink" href="#performance-comparison" title="Link to this heading">¶</a></h2>
<p>Let’s compare the timing of autodiff vs custom Jacobians. Note that for this simple example, the difference may be small or even favor autodiff due to JAX’s optimizations. Custom Jacobians are most beneficial for:</p>
<ul class="simple">
<li><p>Complex functions where the analytical Jacobian is simpler</p></li>
<li><p>Cases where intermediate values can be heavily reused</p></li>
<li><p>Very high-dimensional problems where autodiff has significant overhead</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">benchmark_solver</span><span class="p">(</span><span class="n">cost_factory</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Benchmark a solver configuration.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Minimum time per solve in milliseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cost_factory</span><span class="p">(</span>
            <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_targets</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span>
            <span class="n">targets</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">initial_vals</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="o">.</span><span class="n">make</span><span class="p">([</span><span class="n">var</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]))])</span>
    <span class="n">problem</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">LeastSquaresProblem</span><span class="p">(</span><span class="n">costs</span><span class="p">,</span> <span class="p">[</span><span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">analyze</span><span class="p">()</span>

    <span class="c1"># Warmup (JIT compilation).</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">initial_vals</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

    <span class="c1"># Timed runs.</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">initial_vals</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>  <span class="c1"># Important: wait for async execution!</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

    <span class="n">min_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># Convert to ms.</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">min_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> ms (min of </span><span class="si">{</span><span class="n">num_runs</span><span class="si">}</span><span class="s2"> runs)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">min_time</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Benchmarking solve times...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">t_autodiff</span> <span class="o">=</span> <span class="n">benchmark_solver</span><span class="p">(</span><span class="n">distance_cost_autodiff</span><span class="p">,</span> <span class="s2">&quot;Autodiff      &quot;</span><span class="p">)</span>
<span class="n">t_custom</span> <span class="o">=</span> <span class="n">benchmark_solver</span><span class="p">(</span><span class="n">distance_cost_custom</span><span class="p">,</span> <span class="s2">&quot;Custom Jacobian&quot;</span><span class="p">)</span>
<span class="n">t_cached</span> <span class="o">=</span> <span class="n">benchmark_solver</span><span class="p">(</span><span class="n">distance_cost_cached</span><span class="p">,</span> <span class="s2">&quot;With Cache     &quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Benchmarking solve times...

<span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_autodiff
Autodiff      : 0.290 ms (min of 20 runs)
<span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_custom
Custom Jacobian: 0.283 ms (min of 20 runs)
<span class=" -Color -Color-Bold">INFO    </span> | Building optimization problem with 100 terms and 1 variables: 100 costs, 0 eq_zero, 0 leq_zero, 0 geq_zero
<span class=" -Color -Color-Bold">INFO    </span> | Vectorizing group with 100 costs, 1 variables each: distance_cost_cached
With Cache     : 0.290 ms (min of 20 runs)
</pre></div>
</div>
</div>
</div>
</section>
<section id="multiple-variables">
<h2>Multiple variables<a class="headerlink" href="#multiple-variables" title="Link to this heading">¶</a></h2>
<p>When a cost involves multiple variables, the Jacobian concatenates their tangent dimensions in the order they appear as arguments. For example, a cost with two <code class="docutils literal notranslate"><span class="pre">Point2DVar</span></code> variables would have a Jacobian of shape <code class="docutils literal notranslate"><span class="pre">(residual_dim,</span> <span class="pre">4)</span></code> (2 + 2 tangent dims).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">two_point_jacobian</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var_a</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">var_b</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Jacobian for distance between two points.</span>

<span class="sd">    The residual is ||p_a - p_b||, and the Jacobian has shape (1, 4)</span>
<span class="sd">    with columns [d/dp_a, d/dp_b].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_a</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var_a</span><span class="p">]</span>
    <span class="n">p_b</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">var_b</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">p_a</span> <span class="o">-</span> <span class="n">p_b</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="c1"># d/dp_a = (p_a - p_b) / ||p_a - p_b||.</span>
    <span class="c1"># d/dp_b = -(p_a - p_b) / ||p_a - p_b||.</span>
    <span class="n">jac_a</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">dist</span>
    <span class="n">jac_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span> <span class="o">/</span> <span class="n">dist</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jac_a</span><span class="p">,</span> <span class="n">jac_b</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>


<span class="nd">@jaxls</span><span class="o">.</span><span class="n">Cost</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">jac_custom_fn</span><span class="o">=</span><span class="n">two_point_jacobian</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">two_point_distance</span><span class="p">(</span>
    <span class="n">vals</span><span class="p">:</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="p">,</span>
    <span class="n">var_a</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
    <span class="n">var_b</span><span class="p">:</span> <span class="n">Point2DVar</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distance between two points.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">var_a</span><span class="p">]</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="n">var_b</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># Verify the multi-variable Jacobian shape.</span>
<span class="n">var_a</span> <span class="o">=</span> <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">var_b</span> <span class="o">=</span> <span class="n">Point2DVar</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_vals</span> <span class="o">=</span> <span class="n">jaxls</span><span class="o">.</span><span class="n">VarValues</span><span class="o">.</span><span class="n">make</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">var_a</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])),</span>
        <span class="n">var_b</span><span class="o">.</span><span class="n">with_value</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">jac</span> <span class="o">=</span> <span class="n">two_point_jacobian</span><span class="p">(</span><span class="n">test_vals</span><span class="p">,</span> <span class="n">var_a</span><span class="p">,</span> <span class="n">var_b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Two-variable Jacobian shape: </span><span class="si">{</span><span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Jacobian:</span><span class="se">\n</span><span class="si">{</span><span class="n">jac</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Two-variable Jacobian shape: (1, 4)
Jacobian:
[[ 0.70710677 -0.70710677 -0.70710677  0.70710677]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="important-notes">
<h2>Important notes<a class="headerlink" href="#important-notes" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Correctness: Custom Jacobians bypass autodiff entirely. If your Jacobian is incorrect, the solver may converge to the wrong solution or fail to converge. Always verify against autodiff during development.</p></li>
<li><p>Shape requirements: The Jacobian must be a 2D array with shape <code class="docutils literal notranslate"><span class="pre">(residual_dim,</span> <span class="pre">total_tangent_dim)</span></code>. The tangent dimensions are concatenated in the order variables appear as arguments.</p></li>
<li><p>Caching: Use <code class="docutils literal notranslate"><span class="pre">jac_custom_with_cache_fn</span></code> when the residual computation produces expensive intermediate values that the Jacobian can reuse. This avoids duplicate computation.</p></li>
</ol>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../constraints/">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Constraints</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../non_euclidean/">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Non-Euclidean variables</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/brentyi/jaxls" aria-label="GitHub">
            <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Custom Jacobians</a><ul>
<li><a class="reference internal" href="#when-to-use-custom-jacobians">When to use custom Jacobians</a></li>
<li><a class="reference internal" href="#problem-setup-2d-point-fitting">Problem setup: 2D point fitting</a></li>
<li><a class="reference internal" href="#basic-usage-jac-custom-fn">Basic usage: <code class="docutils literal notranslate"><span class="pre">jac_custom_fn</span></code></a></li>
<li><a class="reference internal" href="#with-cache-jac-custom-with-cache-fn">With cache: <code class="docutils literal notranslate"><span class="pre">jac_custom_with_cache_fn</span></code></a></li>
<li><a class="reference internal" href="#jacobian-shape-requirements">Jacobian shape requirements</a></li>
<li><a class="reference internal" href="#solving-the-optimization-problem">Solving the optimization problem</a></li>
<li><a class="reference internal" href="#performance-comparison">Performance comparison</a></li>
<li><a class="reference internal" href="#multiple-variables">Multiple variables</a></li>
<li><a class="reference internal" href="#important-notes">Important notes</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=fd10adb8"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>